<!-- core/templates/core/components/post_card.html -->
{% load static %}
<div class="post-card" data-post-id="{{ post.id }}">
    <!-- Repost Header (if this is a repost) -->
    {% if post.repost_parent %}
    <div class="repost-header">
        <i class="fas fa-retweet"></i>
        <span>
            <a href="{% url 'profile' post.author.username %}">
                {{ post.author.profile.full_name }}
            </a>
            reposted
        </span>
    </div>
    {% endif %}

    <!-- Original Post Header -->
    <div class="post-header">
        <div class="post-user-info">
            <a href="{% url 'profile' post.author.username %}" class="user-avatar-link">
                {% if post.author.profile.profile_pic %}
                    <img src="{{ post.author.profile.profile_pic.url }}" alt="{{ post.author.username }}" class="user-avatar">
                {% else %}
                    <div class="default-avatar">
                        {{ post.author.username|first|upper }}
                    </div>
                {% endif %}
            </a>
            <div class="user-details">
                <a href="{% url 'profile' post.author.username %}" class="user-name">
                    {{ post.author.profile.full_name }}
                </a>
                <div class="post-meta">
                    <span class="post-time">{{ post.created_at|timesince }} ago</span>
                    <span class="post-privacy">
                        <i class="fas fa-globe-americas"></i>
                        Public
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Post Options Menu -->
        <div class="post-options">
            <button class="post-menu-btn" onclick="window.togglePostMenu('{{ post.id }}')">
                <i class="fas fa-ellipsis-h"></i>
            </button>
            <div class="post-menu-dropdown" id="postMenu-{{ post.id }}">
                {% if post.author == request.user %}
                    <button class="menu-item" onclick="window.editPost('{{ post.id }}')">
                        <i class="fas fa-edit"></i>
                        <span>Edit Post</span>
                    </button>
                    <button class="menu-item" onclick="window.deletePost('{{ post.id }}')">
                        <i class="fas fa-trash"></i>
                        <span>Delete Post</span>
                    </button>
                    <div class="menu-divider"></div>
                {% endif %}
                <button class="menu-item" onclick="window.repost('{{ post.id }}')">
                    <i class="fas fa-retweet"></i>
                    <span>Repost</span>
                </button>
                <button class="menu-item" onclick="window.quotePost('{{ post.id }}')">
                    <i class="fas fa-quote-left"></i>
                    <span>Quote Post</span>
                </button>
                <button class="menu-item" onclick="savePost('{{ post.id }}')">
                    <i class="fas fa-bookmark"></i>
                    <span>Save Post</span>
                </button>
                <button class="menu-item" onclick="copyPostLink('{{ post.id }}')">
                    <i class="fas fa-link"></i>
                    <span>Copy Link</span>
                </button>
                <button class="menu-item" onclick="reportPost('{{ post.id }}')">
                    <i class="fas fa-flag"></i>
                    <span>Report Post</span>
                </button>
                {% if post.author != request.user %}
                    <div class="menu-divider"></div>
                    <button class="menu-item" onclick="toggleFollow('{{ post.author.id }}', this)">
                        <i class="fas fa-user-plus"></i>
                        <span>Follow {{ post.author.username }}</span>
                    </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Post Content -->
    <div class="post-content">
        {% if post.content %}
            <div class="post-text">
                {{ post.content|linebreaksbr }}
            </div>
        {% endif %}
        
        {% if post.image %}
            <div class="post-media">
                <div class="media-container">
                    <img src="{{ post.image.url }}" 
                         alt="Post image" 
                         class="post-image"
                         onclick="openImageModal('{{ post.image.url }}')"
                         loading="lazy">
                    
                    <!-- Image Actions Overlay -->
                    <div class="media-actions">
                        <button class="media-action-btn" onclick="editPostImage('{{ post.id }}', '{{ post.image.url }}')">
                            <i class="fas fa-edit"></i>
                            <span>Edit</span>
                        </button>
                        <button class="media-action-btn" onclick="downloadImage('{{ post.image.url }}')">
                            <i class="fas fa-download"></i>
                            <span>Download</span>
                        </button>
                        <button class="media-action-btn" onclick="openImageFilters('{{ post.id }}', '{{ post.image.url }}')">
                            <i class="fas fa-magic"></i>
                            <span>Filters</span>
                        </button>
                    </div>
                </div>
            </div>
        {% endif %}
        
        {% if post.video %}
            <div class="post-media">
                <video controls class="post-video">
                    <source src="{{ post.video.url }}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
        {% endif %}
    </div>

    <!-- Post Stats -->
    <div class="post-stats">
        <div class="stats-left">
            <div class="likes-stat" onclick="showLikesModal('{{ post.id }}')">
                <div class="likes-preview">
                    <i class="fas fa-heart"></i>
                    <span class="like-count">{{ post.likes.count }}</span>
                </div>
            </div>
            <div class="reposts-stat" onclick="showRepostsModal('{{ post.id }}')">
                <div class="reposts-preview">
                    <i class="fas fa-retweet"></i>
                    <span class="repost-count">{{ post.reposts.count }}</span>
                </div>
            </div>
        </div>
        <div class="stats-right">
            <span class="comment-count">{{ post.comments.count }} comments</span>
            <span class="share-count">{{ post.shares.count }} shares</span>
        </div>
    </div>

    <!-- Post Actions -->
    <div class="post-actions">
        <button class="post-action-btn like-btn {% if request.user in post.likes.all %}liked{% endif %}" 
                data-post-id="{{ post.id }}"
                onclick="window.toggleLike('{{ post.id }}', this)">
            <i class="fas fa-heart"></i>
            <span class="action-text">
                {% if request.user in post.likes.all %}Liked{% else %}Like{% endif %}
            </span>
        </button>
        
        <button class="post-action-btn comment-btn" 
                onclick="window.toggleComments('{{ post.id }}')">
            <i class="fas fa-comment"></i>
            <span>Comment</span>
        </button>
        
        <div class="repost-container">
            <button class="post-action-btn repost-btn" 
                    onclick="window.toggleRepostMenu('{{ post.id }}')">
                <i class="fas fa-retweet"></i>
                <span>Repost</span>
            </button>
            <div class="repost-dropdown" id="repostMenu-{{ post.id }}">
                <button class="repost-option" onclick="window.repost('{{ post.id }}')">
                    <i class="fas fa-retweet"></i>
                    <span>Repost</span>
                </button>
                <button class="repost-option" onclick="window.quotePost('{{ post.id }}')">
                    <i class="fas fa-quote-left"></i>
                    <span>Quote Post</span>
                </button>
            </div>
        </div>
        
        <div class="share-container">
            <button class="post-action-btn share-btn" 
                    onclick="toggleShareMenu('{{ post.id }}')">
                <i class="fas fa-share"></i>
                <span>Share</span>
            </button>
            <div class="share-dropdown" id="shareMenu-{{ post.id }}">
                <button class="share-option" onclick="shareToFeed('{{ post.id }}')">
                    <i class="fas fa-newspaper"></i>
                    <span>Share to Feed</span>
                </button>
                <button class="share-option" onclick="shareToMessage('{{ post.id }}')">
                    <i class="fas fa-envelope"></i>
                    <span>Send in Message</span>
                </button>
                <button class="share-option" onclick="shareToStory('{{ post.id }}')">
                    <i class="fas fa-camera"></i>
                    <span>Share to Story</span>
                </button>
                <div class="share-divider"></div>
                <button class="share-option" onclick="copyPostLink('{{ post.id }}')">
                    <i class="fas fa-link"></i>
                    <span>Copy Link</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Comments Section -->
    <div class="comments-section" id="commentsSection-{{ post.id }}" style="display: none;">
        <!-- Enhanced Add Comment Form -->
        <div class="add-comment-form">
            <div class="comment-avatar">
                {% if user.profile.profile_pic %}
                    <img src="{{ user.profile.profile_pic.url }}" alt="Profile" class="user-avatar small">
                {% else %}
                    <div class="default-avatar small">
                        {{ user.username|first|upper }}
                    </div>
                {% endif %}
            </div>
            <div class="comment-input-container">
                <div class="comment-input-wrapper">
                    <textarea class="comment-input" 
                              placeholder="Write a comment..." 
                              id="commentInput-{{ post.id }}"
                              oninput="autoResizeComment(this)"
                              onkeydown="handleCommentKeydown(event, '{{ post.id }}')"></textarea>
                    
                    <!-- Comment Media Preview -->
                    <div class="comment-media-preview" id="commentMediaPreview-{{ post.id }}"></div>
                </div>
                
                <div class="comment-actions-bar">
                    <div class="comment-attachments">
                        <button class="comment-action-btn" onclick="openCommentEmojiPicker('{{ post.id }}')" type="button">
                            <i class="fas fa-smile"></i>
                        </button>
                        <button class="comment-action-btn" onclick="addCommentImage('{{ post.id }}')" type="button">
                            <i class="fas fa-image"></i>
                        </button>
                        <button class="comment-action-btn" onclick="addCommentSticker('{{ post.id }}')" type="button">
                            <i class="fas fa-sticky-note"></i>
                        </button>
                        <button class="comment-action-btn" onclick="addCommentGIF('{{ post.id }}')" type="button">
                            <i class="fas fa-film"></i>
                        </button>
                    </div>
                    <button class="comment-submit-btn" onclick="window.submitComment('{{ post.id }}')" type="button">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Comments List -->
        <div class="comments-list" id="commentsList-{{ post.id }}">
            {% for comment in post.comments.all|slice:":5" %}
            <div class="comment-wrapper" data-comment-id="{{ comment.id }}">
                <div class="comment-avatar">
                    {% if comment.user.profile.profile_pic %}
                        <img src="{{ comment.user.profile.profile_pic.url }}" alt="{{ comment.user.username }}">
                    {% else %}
                        <div class="comment-avatar-default">
                            {{ comment.user.username|first|upper }}
                        </div>
                    {% endif %}
                </div>
                
                <div class="comment-main">
                    <div class="comment-bubble">
                        <div class="comment-header">
                            <div class="comment-user-info">
                                <span class="comment-name">
                                    {% if comment.user.get_full_name %}
                                        {{ comment.user.get_full_name }}
                                    {% else %}
                                        {{ comment.user.username }}
                                    {% endif %}
                                </span>
                                <span class="comment-timestamp">{{ comment.created_at|timesince }} ago</span>
                            </div>
                            
                            <div class="comment-options">
                                <button class="comment-options-btn" onclick="toggleCommentOptions({{ comment.id }})">
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                                <div class="comment-options-menu" id="commentOptions-{{ comment.id }}">
                                    {% if comment.user == request.user %}
                                        <button onclick="editCommentAction({{ comment.id }})">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        <button onclick="deleteCommentAction({{ comment.id }})">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    {% else %}
                                        <button onclick="reportCommentAction({{ comment.id }})">
                                            <i class="fas fa-flag"></i> Report
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="comment-content">{{ comment.content }}</div>
                    </div>
                    
                    <div class="comment-actions">
                        <button class="comment-action-btn like-btn" onclick="likeCommentAction({{ comment.id }}, this)">
                            <i class="fas fa-heart"></i>
                            <span>Like</span>
                        </button>
                        
                        <button class="comment-action-btn reply-btn" onclick="replyToCommentAction({{ comment.id }}, '{{ comment.user.username }}', '{{ post.id }}')">
                            <i class="fas fa-reply"></i>
                            <span>Reply</span>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
            
            {% if post.comments.count > 5 %}
                <button class="load-more-comments" onclick="loadMoreComments('{{ post.id }}')">
                    Load {{ post.comments.count|add:"-5" }} more comments
                </button>
            {% endif %}
        </div>
    </div>
</div>

<link rel="stylesheet" href="{% static 'css/comment-fix.css' %}">

<style>
/* Ultra Modern Comment System - Kesari Theme */
:root {
    --kesari-primary: #FF9933;
    --kesari-hover: #e6851a;
    --kesari-light: #ffad5c;
    --comment-bg-light: #f8f9fa;
    --comment-bg-dark: #2d2d30;
    --comment-border: #e1e5e9;
    --comment-shadow: 0 2px 8px rgba(0,0,0,0.08);
    --comment-shadow-hover: 0 4px 16px rgba(0,0,0,0.12);
}

.comment-wrapper {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
    align-items: flex-start;
    position: relative;
    padding: 8px 0;
    transition: all 0.3s ease;
}

body:not([data-theme="dark"]) .comment-wrapper:hover {
    background: rgba(255, 153, 51, 0.02);
    border-radius: 12px;
    padding: 12px 8px;
    margin: 4px -8px 12px -8px;
}

body[data-theme="dark"] .comment-wrapper:hover {
    background: rgba(255, 153, 51, 0.08) !important;
    border-radius: 12px !important;
    padding: 12px 8px !important;
    margin: 4px -8px 12px -8px !important;
}

.comment-avatar {
    width: 36px;
    height: 36px;
    flex-shrink: 0;
    position: relative;
}

.comment-avatar img,
.comment-avatar-default {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.comment-wrapper:hover .comment-avatar img,
.comment-wrapper:hover .comment-avatar-default {
    border-color: var(--kesari-primary);
    transform: scale(1.05);
}

.comment-avatar-default {
    background: linear-gradient(135deg, var(--kesari-primary), var(--kesari-light));
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: white;
    font-size: 14px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

.comment-main {
    flex: 1;
    min-width: 0;
}

.comment-bubble {
    background: var(--comment-bg-light);
    border-radius: 18px;
    padding: 12px 16px;
    position: relative;
    box-shadow: var(--comment-shadow);
    border: 1px solid var(--comment-border);
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

body:not([data-theme="dark"]) .comment-wrapper:hover .comment-bubble {
    box-shadow: var(--comment-shadow-hover);
    transform: translateY(-1px);
    border-color: rgba(255, 153, 51, 0.2);
}

body[data-theme="dark"] .comment-wrapper:hover .comment-bubble {
    background: #353538 !important;
    border-color: rgba(255, 153, 51, 0.3) !important;
    box-shadow: 0 4px 16px rgba(0,0,0,0.5) !important;
    transform: translateY(-1px) !important;
}

.comment-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.comment-user-info {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}

.comment-name {
    font-weight: 700;
    color: var(--text-primary, #1a1a1a);
    font-size: 14px;
    line-height: 1.2;
    text-decoration: none;
    transition: color 0.2s ease;
}

.comment-name:hover {
    color: var(--kesari-primary);
    cursor: pointer;
}

.comment-timestamp {
    color: var(--text-secondary, #8e8e93);
    font-size: 12px;
    font-weight: 500;
    opacity: 0.8;
}

.comment-options {
    position: relative;
    flex-shrink: 0;
    opacity: 0;
    transition: all 0.3s ease;
}

.comment-wrapper:hover .comment-options {
    opacity: 1;
}

.comment-options-btn {
    background: rgba(255, 153, 51, 0.1);
    border: none;
    color: var(--kesari-primary);
    cursor: pointer;
    padding: 6px;
    border-radius: 50%;
    font-size: 12px;
    transition: all 0.3s ease;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
}

.comment-options-btn:hover {
    background: var(--kesari-primary);
    color: white;
    transform: rotate(90deg) scale(1.1);
    box-shadow: 0 4px 12px rgba(255, 153, 51, 0.3);
}

.comment-options-menu {
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border: 1px solid var(--comment-border);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    min-width: 140px;
    z-index: 1000;
    display: none;
    overflow: hidden;
    backdrop-filter: blur(20px);
    animation: slideDown 0.2s ease;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.comment-options-menu button {
    width: 100%;
    padding: 12px 16px;
    border: none;
    background: none;
    text-align: left;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    font-weight: 500;
    color: var(--text-primary, #1a1a1a);
    transition: all 0.2s ease;
}

.comment-options-menu button:hover {
    background: linear-gradient(90deg, rgba(255, 153, 51, 0.1), rgba(255, 153, 51, 0.05));
    color: var(--kesari-primary);
    transform: translateX(4px);
}

.comment-options-menu button i {
    width: 16px;
    text-align: center;
}

.comment-content {
    color: var(--text-primary, #1a1a1a);
    font-size: 14px;
    line-height: 1.5;
    word-wrap: break-word;
    margin-bottom: 2px;
    font-weight: 400;
}

.comment-actions {
    display: flex;
    gap: 20px;
    margin-top: 10px;
    padding-left: 4px;
    align-items: center;
}

.comment-action-btn {
    background: none;
    border: none;
    color: var(--text-secondary, #8e8e93);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border-radius: 20px;
    transition: all 0.3s ease;
    text-transform: capitalize;
    position: relative;
    overflow: hidden;
}

.comment-action-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 153, 51, 0.1), transparent);
    transition: left 0.5s ease;
}

.comment-action-btn:hover::before {
    left: 100%;
}

.comment-action-btn:hover {
    background: rgba(255, 153, 51, 0.08);
    color: var(--kesari-primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 153, 51, 0.15);
}

.comment-action-btn.like-btn.liked {
    background: linear-gradient(135deg, var(--kesari-primary), var(--kesari-light));
    color: white;
    box-shadow: 0 4px 16px rgba(255, 153, 51, 0.3);
}

.comment-action-btn.like-btn.liked:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 6px 20px rgba(255, 153, 51, 0.4);
}

.comment-action-btn i {
    font-size: 12px;
    transition: transform 0.3s ease;
}

.comment-action-btn:hover i {
    transform: scale(1.2);
}

.comment-action-btn.like-btn.liked i {
    animation: heartBeat 0.6s ease;
}

@keyframes heartBeat {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.3); }
}

/* Responsive Design */
@media (max-width: 768px) {
    .comment-wrapper {
        gap: 10px;
        margin-bottom: 12px;
    }
    
    .comment-avatar {
        width: 32px;
        height: 32px;
    }
    
    .comment-bubble {
        padding: 10px 12px;
        border-radius: 16px;
    }
    
    .comment-actions {
        gap: 16px;
        flex-wrap: wrap;
    }
    
    .comment-action-btn {
        padding: 6px 10px;
        font-size: 11px;
    }
    
    .comment-user-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 2px;
    }
}

@media (max-width: 480px) {
    .comment-wrapper:hover {
        margin: 4px -4px 12px -4px;
        padding: 8px 4px;
    }
    
    .comment-actions {
        gap: 12px;
    }
    
    .comment-action-btn {
        padding: 4px 8px;
        gap: 4px;
    }
    
    .comment-options-menu {
        min-width: 120px;
        right: -10px;
    }
}

/* Dark Mode - Maximum Specificity */
body[data-theme="dark"] .comment-bubble {
    background: #2d2d30 !important;
    border-color: #404040 !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4) !important;
}

body[data-theme="dark"] .comment-name {
    color: #e4e6ea !important;
}

body[data-theme="dark"] .comment-name:hover {
    color: #FF9933 !important;
}

body[data-theme="dark"] .comment-timestamp {
    color: #b0b3b8 !important;
}

body[data-theme="dark"] .comment-content {
    color: #e4e6ea !important;
}

body[data-theme="dark"] .comment-options-btn {
    background: rgba(255, 153, 51, 0.15) !important;
    color: #FF9933 !important;
}

body[data-theme="dark"] .comment-options-btn:hover {
    background: #FF9933 !important;
    color: white !important;
}

body[data-theme="dark"] .comment-options-menu {
    background: #242526 !important;
    border-color: #404040 !important;
    box-shadow: 0 8px 32px rgba(0,0,0,0.6) !important;
}

body[data-theme="dark"] .comment-options-menu button {
    color: #e4e6ea !important;
}

body[data-theme="dark"] .comment-options-menu button:hover {
    background: rgba(255, 153, 51, 0.2) !important;
    color: #ffad5c !important;
}

body[data-theme="dark"] .comment-action-btn {
    color: #b0b3b8 !important;
}

body[data-theme="dark"] .comment-action-btn:hover {
    background: rgba(255, 153, 51, 0.15) !important;
    color: #ffad5c !important;
}

body[data-theme="dark"] .comment-action-btn.like-btn.liked {
    background: linear-gradient(135deg, #FF9933, #ffad5c) !important;
    color: white !important;
}
</style>

<script>
// Comment Functions
function toggleCommentOptions(commentId) {
    const dropdown = document.getElementById(`commentOptions-${commentId}`);
    const isVisible = dropdown.style.display === 'block';
    
    // Hide all other comment dropdowns
    document.querySelectorAll('.comment-options-menu').forEach(dd => {
        dd.style.display = 'none';
    });
    
    dropdown.style.display = isVisible ? 'none' : 'block';
}

function likeCommentAction(commentId, button) {
    button.classList.toggle('liked');
    const span = button.querySelector('span');
    span.textContent = button.classList.contains('liked') ? 'Liked' : 'Like';
}

function replyToCommentAction(commentId, username, postId) {
    const commentInput = document.getElementById(`commentInput-${postId}`);
    commentInput.value = `@${username} `;
    commentInput.focus();
}

function editCommentAction(commentId) {
    console.log('Edit comment:', commentId);
    toggleCommentOptions(commentId);
}

function deleteCommentAction(commentId) {
    if (confirm('Delete this comment?')) {
        document.querySelector(`[data-comment-id="${commentId}"]`).remove();
    }
    toggleCommentOptions(commentId);
}

function reportCommentAction(commentId) {
    if (confirm('Report this comment?')) {
        console.log('Report comment:', commentId);
    }
    toggleCommentOptions(commentId);
}

// Close comment dropdowns when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.comment-options')) {
        document.querySelectorAll('.comment-options-menu').forEach(dropdown => {
            dropdown.style.display = 'none';
        });
    }
});

// Enhanced Comment System
function autoResizeComment(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
}

function handleCommentKeydown(event, postId) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        submitComment(postId);
    }
}

// Enhanced Comment Submission
async function submitComment(postId) {
    const commentInput = document.getElementById(`commentInput-${postId}`);
    const commentText = commentInput.value.trim();
    const mediaPreview = document.getElementById(`commentMediaPreview-${postId}`);
    
    // Check if we have content or media
    const hasMedia = mediaPreview.children.length > 0;
    
    if (!commentText && !hasMedia) {
        showNotification('Please add some text or media to your comment', 'error');
        return;
    }

    try {
        const formData = new FormData();
        formData.append('post_id', postId);
        formData.append('content', commentText);
        formData.append('csrfmiddlewaretoken', getCSRFToken());

        // Add media files if any
        const mediaFiles = window.commentMediaFiles?.[postId] || [];
        mediaFiles.forEach((file, index) => {
            formData.append(`comment_media_${index}`, file);
        });

        const response = await fetch('/api/add_comment/', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const comment = await response.json();
            addCommentToDOM(postId, comment);
            
            // Reset form
            commentInput.value = '';
            commentInput.style.height = 'auto';
            mediaPreview.innerHTML = '';
            
            // Clear stored media files
            if (window.commentMediaFiles) {
                window.commentMediaFiles[postId] = [];
            }
            
            // Update comment count
            const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
            commentCount.textContent = parseInt(commentCount.textContent) + 1;
            
            showNotification('Comment added successfully');
        }
    } catch (error) {
        console.error('Error adding comment:', error);
        showNotification('Error adding comment', 'error');
    }
}

// Utility function
function getCSRFToken() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    return csrfToken ? csrfToken.value : '';
}
</script>
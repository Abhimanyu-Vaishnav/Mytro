<!-- core/templates/core/components/post_card.html -->
{% load static %}
{% load post_extras %}
<link rel="stylesheet" href="{% static 'css/post_card.css' %}">
<div class="post-card" data-post-id="{{ post.id }}">
    <!-- Repost / Quote header -->
    {% if post.repost_parent %}
        <div class="repost-header">
            <i class="fas fa-retweet" aria-hidden="true"></i>
            <span class="repost-text">{{ post.author.username }} reposted</span>
            <small class="repost-time">&middot; {{ post.created_at|timesince }} ago</small>
        </div>
    {% endif %}

    <!-- Post Header -->
    <div class="post-header">
        <div class="post-user-info">
            <a href="{% url 'profile' post.author.username %}" class="user-avatar-link">
                {% if post.author.profile.profile_pic %}
                    <img src="{{ post.author.profile.profile_pic.url }}" alt="{{ post.author.username }}" class="user-avatar">
                {% else %}
                    <div class="default-avatar">
                        {{ post.author.username|first|upper }}
                    </div>
                {% endif %}
            </a>
            <div class="user-details">
                <a href="{% url 'profile' post.author.username %}" class="user-name">
                    {{ post.author.profile.full_name|default:post.author.username }}
                </a>
                <div class="post-meta">
                    <span class="post-time">{{ post.created_at|timesince }} ago</span>
                </div>
            </div>
        </div>
        <div class="post-options">
            <button class="post-menu-btn" aria-haspopup="true" aria-expanded="false" onclick="togglePostMenu('{{ post.id }}')">
                <i class="fas fa-ellipsis-h" aria-hidden="true"></i>
                <span class="sr-only">Open post menu</span>
            </button>
            <div class="post-menu-dropdown" id="postMenu-{{ post.id }}" role="menu">
                {% if post.author == request.user %}
                    <button class="menu-item" onclick="editPost('{{ post.id }}')">
                        <i class="fas fa-edit"></i> Edit Post
                    </button>
                    <button class="menu-item" onclick="deletePost('{{ post.id }}')">
                        <i class="fas fa-trash"></i> Delete Post
                    </button>
                {% endif %}
                <button class="menu-item" onclick="repost('{{ post.id }}')" role="menuitem">
                    <i class="fas fa-retweet"></i> Repost
                </button>
                <button class="menu-item" onclick="openQuoteModal('{{ post.id }}')" role="menuitem">
                    <i class="fas fa-quote-left"></i> Quote Post
                </button>
                <button class="menu-item" onclick="savePost('{{ post.id }}')" role="menuitem">
                    <i class="fas fa-bookmark"></i> Save Post
                </button>
                <button class="menu-item" onclick="copyPostLink('{{ post.id }}')" role="menuitem">
                    <i class="fas fa-link"></i> Copy Link
                </button>
                <button class="menu-item" onclick="openReportModal('{{ post.id }}')" role="menuitem">
                    <i class="fas fa-flag"></i> Report Post
                </button>
            </div>
        </div>
    </div>

    <!-- Quote Modal -->
    <div class="quote-modal" id="quoteModal-{{ post.id }}" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="quoteModalLabel-{{ post.id }}">
        <div class="quote-modal-overlay" onclick="closeQuoteModal('{{ post.id }}')"></div>
        <div class="quote-modal-panel">
            <h3 id="quoteModalLabel-{{ post.id }}">Quote Post</h3>
            <div class="quote-original">
                <strong>{{ post.author.username }}</strong>
                <p class="quote-original-text">{{ post.content|truncatechars:200 }}</p>
            </div>
            <textarea id="quoteText-{{ post.id }}" placeholder="Add your thoughts..." rows="4" aria-label="Quote text" maxlength="1000"></textarea>
            <div class="quote-counter"><span id="quoteCount-{{ post.id }}">0</span>/1000</div>
            <div class="quote-actions">
                <button class="btn btn-secondary" onclick="closeQuoteModal('{{ post.id }}')">Cancel</button>
                <button class="btn btn-primary" onclick="submitQuote('{{ post.id }}')">Quote</button>
            </div>
        </div>
    </div>

    <!-- Post Content -->
    <div class="post-content">
        {% if post.is_quote and post.quote_text %}
            <div class="quote-text">{{ post.quote_text|linebreaksbr }}</div>
        {% endif %}
        {% if post.content %}
            <p>{{ post.content|safe }}</p>
        {% endif %}
        {% if post.image %}
            <img src="{{ post.image.url }}" alt="Post Image" class="post-image" loading="lazy" onclick="openLightbox(this, '{{ post.image.url }}')">
        {% endif %}

        {% if post.repost_parent %}
            <div class="repost-preview">
                <div class="repost-preview-header">
                    <a href="{% url 'profile' post.repost_parent.author.username %}">{{ post.repost_parent.author.username }}</a>
                    <span class="small-time">&middot; {{ post.repost_parent.created_at|timesince }} ago</span>
                </div>
                <div class="repost-preview-content">{{ post.repost_parent.content|truncatechars:200 }}</div>
                {% if post.repost_parent.image %}
                    <img src="{{ post.repost_parent.image.url }}" alt="Reposted image" class="repost-preview-image" loading="lazy">
                {% endif %}
            </div>
        {% endif %}
    </div>

    <!-- Post Actions -->
    <div class="post-actions" aria-label="Post actions">
        {% comment %} Determine if current user liked this post {% endcomment %}
    {% is_liked post request.user as liked %}
    <button class="action-btn like-btn {% if liked %}liked{% endif %}" data-liked="{% if liked %}true{% else %}false{% endif %}" onclick="likePost('{{ post.id }}')" aria-pressed="{% if liked %}true{% else %}false{% endif %}">
            <i class="fas fa-heart" aria-hidden="true"></i>
            <span class="action-label">Like</span>
            <span class="count like-count" id="likeCount-{{ post.id }}" onclick="openLikedUsers('{{ post.id }}')" role="button" tabindex="0">{{ post.likes.count }}</span>
        </button>

        <button class="action-btn comment-btn" onclick="focusCommentInput('{{ post.id }}')">
            <i class="fas fa-comment" aria-hidden="true"></i>
            <span class="action-label">Comment</span>
            <span class="count" id="commentCount-{{ post.id }}">{{ post.comments.count }}</span>
        </button>

        <!-- Placeholder for share/repost menus already present elsewhere -->

        <button class="action-btn share-btn" onclick="sharePost('{{ post.id }}')">
            <i class="fas fa-share" aria-hidden="true"></i>
            <span class="action-label">Share</span>
        </button>
        
    </div>

    <!-- Comments Section -->
    <div class="comments-section" id="comments-{{ post.id }}">
        <form class="comment-form" onsubmit="submitComment(event, '{{ post.id }}')">
            <input type="text" placeholder="Write a comment..." id="commentInput-{{ post.id }}" aria-label="Write a comment" required>
            <button type="submit" aria-label="Post comment">Post</button>
        </form>
        <div class="comment-list" id="commentList-{{ post.id }}">
            {% for comment in post.comments.all %}
                <div class="comment-item" data-comment-id="{{ comment.id }}">
                    <div class="comment-avatar">
                        {% if comment.user.profile.profile_pic %}
                            <img src="{{ comment.user.profile.profile_pic.url }}" alt="{{ comment.user.username }}">
                        {% else %}
                            <div class="default-avatar">{{ comment.user.username|first|upper }}</div>
                        {% endif %}
                    </div>
                    <div class="comment-content">
                        <div class="comment-bubble">
                            <div class="comment-header">
                                <div class="comment-user-details">
                                    <a href="{% url 'profile' comment.user.username %}" class="comment-author">
                                        {{ comment.user.profile.full_name|default:comment.user.username }}
                                    </a>
                                    <span class="comment-time">{{ comment.created_at|timesince }} ago</span>
                                </div>
                                <div class="comment-menu">
                                    <button class="comment-menu-btn" onclick="toggleCommentMenu({{ comment.id }})">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>
                                    <div class="comment-menu-dropdown" id="comment-menu-{{ comment.id }}">
                                        {% if comment.user == request.user %}
                                            <button onclick="editComment({{ comment.id }})">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button onclick="deleteComment({{ comment.id }})">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        {% else %}
                                            <button onclick="reportComment({{ comment.id }})">
                                                <i class="fas fa-flag"></i> Report
                                            </button>
                                        {% endif %}
                                        <button onclick="copyCommentLink({{ comment.id }})">
                                            <i class="fas fa-link"></i> Copy link
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="comment-text">{{ comment.content|safe }}
                                {% if comment.edited %}
                                    <span class="edited-indicator">(edited)</span>
                                {% endif %}
                            </div>
                            <div class="comment-actions">
                                <button class="comment-action-btn like-btn {% if comment|is_liked_by:request.user %}liked{% endif %}" 
                                        onclick="likeComment({{ comment.id }}, this)">
                                    <i class="fas fa-heart"></i>
                                    <span>{{ comment.likes.count|default:0 }}</span>
                                </button>
                                <button class="comment-action-btn reply-btn" 
                                        onclick="replyToComment({{ comment.id }}, '{{ comment.user.username }}')">
                                    <i class="fas fa-reply"></i>
                                    <span>Reply</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="no-comments">No comments yet — be the first!</div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Liked Users Modal -->
<div class="modal" id="likedUsersModal-{{ post.id }}" role="dialog" aria-hidden="true">
    <div class="modal-overlay" onclick="closeLikedUsers('{{ post.id }}')"></div>
    <div class="modal-panel">
        <h3>Liked by</h3>
        <div class="liked-users-list" id="likedUsersList-{{ post.id }}">Loading...</div>
        <div class="modal-actions"><button class="btn btn-secondary" onclick="closeLikedUsers('{{ post.id }}')">Close</button></div>
    </div>
</div>

<!-- Delete Confirm Modal -->
<div class="modal" id="deleteConfirmModal-{{ post.id }}" role="dialog" aria-hidden="true">
    <div class="modal-overlay" onclick="closeDeleteConfirm('{{ post.id }}')"></div>
    <div class="modal-panel">
        <h3>Delete Post?</h3>
        <p>Are you sure you want to delete this post? This cannot be undone.</p>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeDeleteConfirm('{{ post.id }}')">Cancel</button>
            <button class="btn btn-danger" onclick="confirmDeletePost('{{ post.id }}')">Delete</button>
        </div>
    </div>
</div>

<!-- Image Lightbox -->
<div class="lightbox" id="imageLightbox" aria-hidden="true">
    <div class="lightbox-overlay" onclick="closeLightbox()"></div>
    <div class="lightbox-panel">
        <img src="" alt="" id="lightboxImage">
        <button class="lightbox-close" onclick="closeLightbox()">×</button>
    </div>
</div>


<script src="{% static 'js/post_card.js' %}"></script>
<script src="{% static 'js/toasts.js' %}"></script>
<link rel="stylesheet" href="{% static 'css/toasts.css' %}">

<script>
// Attach counter handlers for quote modals
document.addEventListener('input', function(e){
    if(e.target && e.target.id && e.target.id.startsWith('quoteText-')){
        const id = e.target.id.split('-')[1];
        const cnt = document.getElementById(`quoteCount-${id}`);
        if(cnt) cnt.textContent = e.target.value.length;
    }
});
</script>
<style>
.post-card {
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 16px;
    padding: 16px;
    border: 1px solid #e1e5e9;
}

/* Post Header */
.post-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.post-user-info {
    display: flex;
    gap: 12px;
    align-items: center;
}

.user-avatar, .default-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.default-avatar {
    background: #FF9933;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 16px;
}

.user-details {
    flex: 1;
}

.user-name {
    font-weight: 600;
    color: #1c1e21;
    text-decoration: none;
    font-size: 15px;
}

.user-name:hover {
    text-decoration: underline;
}

.post-meta {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-top: 2px;
}

.post-time {
    color: #65676b;
    font-size: 13px;
}

/* Post Options */
.post-options {
    position: relative;
}

.post-menu-btn {
    background: none;
    border: none;
    padding: 8px;
    border-radius: 50%;
    cursor: pointer;
    color: #65676b;
    transition: all 0.3s ease;
}

.post-menu-btn:hover {
    background: #f0f2f5;
    color: #FF9933;
}

.post-menu-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    min-width: 200px;
    z-index: 1000;
    display: none;
    padding: 8px 0;
}

.post-menu-dropdown.active {
    display: block;
}

.menu-item {
    width: 100%;
    padding: 12px 16px;
    border: none;
    background: none;
    text-align: left;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
    color: #1c1e21;
    transition: background 0.3s ease;
}

.menu-item:hover {
    background: #f0f2f5;
    color: #FF9933;
}

/* Post Content */
.post-content {
    margin-bottom: 12px;
}

.post-content p {
    font-size: 15px;
    line-height: 1.4;
    color: #1c1e21;
    margin-bottom: 12px;
}

.post-image {
    max-width: 100%;
    max-height: 400px;
    object-fit: contain;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.post-image:hover {
    transform: scale(1.02);
}

/* Post Actions */
.post-actions {
    display: flex;
    justify-content: space-around;
    padding: 8px 0;
    border-top: 1px solid #e1e5e9;
}

.action-btn {
    background: none;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #65676b;
    transition: all 0.3s ease;
    font-weight: 500;
}

.action-btn:hover {
    background: #f0f2f5;
    color: #FF9933;
}

/* Comments Section */
.comments-section {
    margin-top: 16px;
    border-top: 1px solid #e1e5e9;
    padding-top: 16px;
}

.comment-form {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
}

.comment-form input {
    flex: 1;
    padding: 12px 16px;
    border: 1px solid #e1e5e9;
    border-radius: 20px;
    font-size: 14px;
    font-family: inherit;
}

.comment-form button {
    background: #FF9933;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    color: white;
    cursor: pointer;
    transition: background 0.3s ease;
}

.comment-form button:hover {
    background: #e6851a;
}

/* Comments List */
.comment-list {
    max-height: 400px;
    overflow-y: auto;
}

.comment-item {
    display: flex;
    gap: 12px;
    padding: 12px;
    border-radius: 8px;
    transition: background 0.3s ease;
    margin-bottom: 8px;
    position: relative;
}

.comment-item:hover {
    background: #f8f9fa;
}

.comment-avatar, .comment-avatar-default {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
}

.comment-avatar-default {
    background: #FF9933;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 12px;
}

.comment-content {
    flex: 1;
}

.comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.comment-user-details {
    display: flex;
    align-items: center;
    gap: 8px;
}

.comment-user-details strong {
    font-size: 14px;
    color: #1c1e21;
}

.comment-time {
    font-size: 12px;
    color: #65676b;
}

.comment-text {
    font-size: 14px;
    color: #1c1e21;
    line-height: 1.4;
    word-wrap: break-word;
}

.comment-text .edited-indicator {
    font-size: 12px;
    color: #65676b;
    margin-left: 8px;
}

/* Comment Actions (Like, Reply) */
.comment-actions {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-top: 8px;
}

.comment-action-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: #65676b;
    font-size: 13px;
    font-weight: 600;
    padding: 0;
}

.comment-action-btn.liked {
    color: #FF9933;
}

/* Comment Menu (Edit, Delete) */
.comment-menu {
    position: relative;
}

.comment-menu-btn {
    background: none;
    border: none;
    padding: 4px;
    border-radius: 50%;
    cursor: pointer;
    color: #65676b;
}

.comment-menu-btn:hover {
    background: #f0f2f5;
}

.comment-menu-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    min-width: 150px;
    z-index: 1000;
    display: none;
    padding: 8px 0;
}

.comment-menu-dropdown.active {
    display: block;
}

.comment-menu-dropdown button {
    width: 100%;
    padding: 8px 12px;
    border: none;
    background: none;
    text-align: left;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #1c1e21;
    transition: background 0.3s ease;
}

.comment-menu-dropdown button:hover {
    background: #f0f2f5;
}

.no-comments {
    text-align: center;
    padding: 20px;
    color: #8e8e93;
    font-style: italic;
}

.load-more-comments {
    width: 100%;
    padding: 12px;
    background: #f8f9fa;
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    color: #FF9933;
    font-weight: 600;
    cursor: pointer;
    margin-top: 8px;
    transition: all 0.3s ease;
}

.load-more-comments:hover {
    background: #FF9933;
    color: white;
    border-color: #FF9933;
}

/* Responsive */
@media (max-width: 768px) {
    .post-card {
        padding: 12px;
        margin-bottom: 12px;
    }
    
    .post-actions {
        gap: 4px;
    }
    
    .post-action-btn {
        padding: 8px 12px;
        font-size: 13px;
    }
    
    .comment {
        padding: 8px;
    }
    
    .repost-dropdown, .share-dropdown {
        left: 0;
        transform: none;
        right: 0;
        margin: 0 auto;
        width: 200px;
    }
}
</style>

<script>
// Comment Functions
function handleCommentKeydown(event, postId) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        window.submitComment(postId);
    }
}

// Enhanced Comment Submission
window.submitComment = async function(postId) {
    const input = document.getElementById(`commentInput-${postId}`);
    const content = input.value.trim();
    
    if (!content) {
        window.showGlobalNotification('Please enter a comment', 'error');
        return;
    }

    try {
        const csrfToken = getCSRFToken();
        const response = await fetch('/api/comments/add/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                post_id: postId,
                comment: content
            })
        });

        if (response.ok) {
            const data = await response.json();
            input.value = '';
            window.showGlobalNotification('Comment posted!', 'success');
            
            // Add new comment at the TOP
            addNewCommentToDOM(postId, data.comment);
            
            // Update comment count
            updateCommentCount(postId, 1);
        }
    } catch (error) {
        console.error('Comment error:', error);
        window.showGlobalNotification('Error posting comment', 'error');
    }
};

// Add new comment at the TOP
function addNewCommentToDOM(postId, comment) {
    const commentsList = document.getElementById(`commentsList-${postId}`);
    const noComments = commentsList.querySelector('.no-comments');
    
    // Remove "No comments" message if exists
    if (noComments) {
        noComments.remove();
    }
    
    // Create new comment element
    const commentElement = document.createElement('div');
    commentElement.className = 'comment-item';
    commentElement.dataset.commentId = comment.id;
    commentElement.innerHTML = `
        <div class="comment-avatar">
            ${comment.user.avatar ? 
                `<img src="${comment.user.avatar}" alt="${comment.user.name}">` :
                `<div class="default-avatar">${comment.user.name.charAt(0).toUpperCase()}</div>`
            }
        </div>
        <div class="comment-content">
            <div class="comment-bubble">
                <div class="comment-header">
                    <div class="comment-user-details">
                        <a href="/profile/${comment.user.name}/" class="comment-author">${comment.user.name}</a>
                        <span class="comment-time">Just now</span>
                    </div>
                    <div class="comment-menu">
                        <button class="comment-menu-btn" onclick="toggleCommentMenu(${comment.id})">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                        <div class="comment-menu-dropdown" id="comment-menu-${comment.id}">
                            <button onclick="editComment(${comment.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="deleteComment(${comment.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                            <button onclick="copyCommentLink(${comment.id})">
                                <i class="fas fa-link"></i> Copy link
                            </button>
                        </div>
                    </div>
                </div>
                <div class="comment-text">${comment.content}</div>
                <div class="comment-actions">
                    <button class="comment-action-btn like-btn" onclick="likeComment(${comment.id}, this)">
                        <i class="fas fa-heart"></i>
                        <span>0</span>
                    </button>
                    <button class="comment-action-btn reply-btn" onclick="replyToComment(${comment.id}, '${comment.user.name}')">
                        <i class="fas fa-reply"></i>
                        <span>Reply</span>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Insert at the TOP (before load more button if exists)
    const loadMoreBtn = commentsList.querySelector('.load-more-comments');
    if (loadMoreBtn) {
        commentsList.insertBefore(commentElement, loadMoreBtn);
    } else {
        commentsList.insertBefore(commentElement, commentsList.firstChild);
    }
}

// Update comment count
function updateCommentCount(postId, increment = 1) {
    const commentCountElement = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCountElement) {
        const currentCount = parseInt(commentCountElement.textContent) || 0;
        commentCountElement.textContent = `${currentCount + increment} comments`;
    }
}

// Load more comments function
window.loadMoreComments = async function(postId) {
    try {
        const commentsList = document.getElementById(`commentsList-${postId}`);
        const currentComments = commentsList.querySelectorAll('.comment').length - 1; // Exclude load more button
        
        const response = await fetch(`/api/comments/${postId}/?offset=${currentComments}`);
        if (response.ok) {
            const data = await response.json();
            
            // Add new comments
            data.comments.forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.className = 'comment-item';
                commentElement.dataset.commentId = comment.id;
                commentElement.innerHTML = `
                    <div class="comment-avatar">
                        ${comment.user.avatar ? 
                            `<img src="${comment.user.avatar}" alt="${comment.user.name}">` :
                            `<div class="default-avatar">${comment.user.name.charAt(0).toUpperCase()}</div>`
                        }
                    </div>
                    <div class="comment-content">
                        <div class="comment-bubble">
                            <div class="comment-header">
                                <div class="comment-user-details">
                                    <a href="/profile/${comment.user.name}/" class="comment-author">${comment.user.name}</a>
                                    <span class="comment-time">${comment.created_at}</span>
                                </div>
                                <div class="comment-menu">
                                    <button class="comment-menu-btn" onclick="toggleCommentMenu(${comment.id})">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>
                                    <div class="comment-menu-dropdown" id="comment-menu-${comment.id}">
                                        <button onclick="editComment(${comment.id})">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        <button onclick="deleteComment(${comment.id})">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                        <button onclick="copyCommentLink(${comment.id})">
                                            <i class="fas fa-link"></i> Copy link
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="comment-text">${comment.content}</div>
                            <div class="comment-actions">
                                <button class="comment-action-btn like-btn" onclick="likeComment(${comment.id}, this)">
                                    <i class="fas fa-heart"></i>
                                    <span>${comment.likes_count || 0}</span>
                                </button>
                                <button class="comment-action-btn reply-btn" onclick="replyToComment(${comment.id}, '${comment.user.name}')">
                                    <i class="fas fa-reply"></i>
                                    <span>Reply</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Insert before load more button
                const loadMoreBtn = commentsList.querySelector('.load-more-comments');
                commentsList.insertBefore(commentElement, loadMoreBtn);
            });
            
            // Update or remove load more button
            const loadMoreBtn = commentsList.querySelector('.load-more-comments');
            const remainingComments = data.total_count - (currentComments + data.comments.length);
            
            if (remainingComments > 0) {
                loadMoreBtn.textContent = `Load ${remainingComments} more comments`;
            } else {
                loadMoreBtn.remove();
            }
        }
    } catch (error) {
        console.error('Error loading more comments:', error);
    }
};

// ==================== REPOST SYSTEM - FIXED ====================
window.handleRepost = function(postId, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    console.log('🔄 Handling repost for:', postId);
    window.toggleRepostMenu(postId, event);
};

window.toggleRepostMenu = function(postId, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    console.log('📋 Toggling repost menu for:', postId);
    
    const menu = document.getElementById(`repostMenu-${postId}`);
    if (!menu) {
        console.error('❌ Repost menu not found:', postId);
        return;
    }
    
    // Close all other menus first
    document.querySelectorAll('.repost-dropdown.show, .share-dropdown.show').forEach(m => {
        m.classList.remove('show');
    });
    
    // Toggle current menu
    const isVisible = menu.classList.contains('show');
    
    if (isVisible) {
        menu.classList.remove('show');
        console.log('✅ Repost menu hidden');
    } else {
        menu.classList.add('show');
        console.log('✅ Repost menu shown');
    }
};

window.repost = async function(postId, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    try {
        console.log('🔄 Reposting post:', postId);
        
        const csrfToken = getCSRFToken();
        if (!csrfToken) {
            window.showGlobalNotification('Security token missing', 'error');
            return;
        }

        const response = await fetch(`/api/posts/${postId}/repost/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
            }
        });

        if (response.ok) {
            const data = await response.json();
            window.showGlobalNotification('✅ Reposted successfully!', 'success');
            
            // Close menu
            const menu = document.getElementById(`repostMenu-${postId}`);
            if (menu) menu.classList.remove('show');
            
            // Reload after 1 second to show changes
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            throw new Error('Repost failed');
        }
    } catch (error) {
        console.error('❌ Repost error:', error);
        window.showGlobalNotification('Repost feature coming soon!', 'info');
        
        // Close menu on error too
        const menu = document.getElementById(`repostMenu-${postId}`);
        if (menu) menu.classList.remove('show');
    }
};

window.quotePost = function(postId, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    console.log('💬 Quote post for:', postId);
    window.showGlobalNotification('Quote post feature coming soon!', 'info');
    
    // Close menu
    const menu = document.getElementById(`repostMenu-${postId}`);
    if (menu) menu.classList.remove('show');
};

// ==================== SHARE SYSTEM - FIXED ====================
window.toggleShareMenu = function(postId, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    console.log('📤 Toggling share menu for:', postId);
    
    const menu = document.getElementById(`shareMenu-${postId}`);
    if (!menu) {
        console.error('❌ Share menu not found:', postId);
        return;
    }
    
    // Close all other menus first
    document.querySelectorAll('.repost-dropdown.show, .share-dropdown.show').forEach(m => {
        m.classList.remove('show');
    });
    
    // Toggle current menu
    const isVisible = menu.classList.contains('show');
    
    if (isVisible) {
        menu.classList.remove('show');
        console.log('✅ Share menu hidden');
    } else {
        menu.classList.add('show');
        console.log('✅ Share menu shown');
    }
};

// Share functions - FIXED
window.shareToFeed = function(postId, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    window.showGlobalNotification('Share to feed feature coming soon!', 'info');
    
    // Close menu
    const menu = document.getElementById(`shareMenu-${postId}`);
    if (menu) menu.classList.remove('show');
};

window.shareToMessage = function(postId, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    window.showGlobalNotification('Share to message feature coming soon!', 'info');
    
    // Close menu
    const menu = document.getElementById(`shareMenu-${postId}`);
    if (menu) menu.classList.remove('show');
};

window.shareToStory = function(postId, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    window.showGlobalNotification('Share to story feature coming soon!', 'info');
    
    // Close menu
    const menu = document.getElementById(`shareMenu-${postId}`);
    if (menu) menu.classList.remove('show');
};

window.copyPostLink = function(postId, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    const postUrl = `${window.location.origin}/post/${postId}/`;
    navigator.clipboard.writeText(postUrl).then(() => {
        window.showGlobalNotification('✅ Link copied to clipboard!', 'success');
    }).catch(() => {
        window.showGlobalNotification('❌ Failed to copy link', 'error');
    });
    
    // Close menu
    const menu = document.getElementById(`shareMenu-${postId}`);
    if (menu) menu.classList.remove('show');
};

// Close dropdowns when clicking outside - FIXED
document.addEventListener('click', function(event) {
    // Check if click is outside any dropdown
    if (!event.target.closest('.repost-container') && !event.target.closest('.share-container')) {
        document.querySelectorAll('.repost-dropdown.show, .share-dropdown.show').forEach(menu => {
            menu.classList.remove('show');
        });
    }
});

// Also close on escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        document.querySelectorAll('.repost-dropdown.show, .share-dropdown.show').forEach(menu => {
            menu.classList.remove('show');
        });
    }
});

// Toggle comment menu
function toggleCommentMenu(commentId) {
    const menu = document.getElementById(`comment-menu-${commentId}`);
    if (menu) {
        menu.classList.toggle('active');
    }
}

// Close all comment menus when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.comment-menu')) {
        document.querySelectorAll('.comment-menu-dropdown.active').forEach(menu => {
            menu.classList.remove('active');
        });
    }
});
</script>
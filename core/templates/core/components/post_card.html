<!-- core/templates/core/components/post_card.html -->
{% load static %}
<div class="post-card" data-post-id="{{ post.id }}">
    
    <!-- Repost Header -->
    {% if post.repost_parent %}
    <div class="repost-header">
        <i class="fas fa-retweet"></i>
        <span>
            <a href="{% url 'profile' post.author.username %}">
                {{ post.author.profile.full_name|default:post.author.username }}
            </a>
            reposted
            {% if post.repost_parent.author %}
            from 
            <a href="{% url 'profile' post.repost_parent.author.username %}">
                {{ post.repost_parent.author.profile.full_name|default:post.repost_parent.author.username }}
            </a>
            {% endif %}
        </span>
    </div>
    {% endif %}

    <!-- Post Header -->
    <div class="post-header">
        <div class="post-user-info">
            <a href="{% url 'profile' post.author.username %}" class="user-avatar-link">
                {% if post.author.profile.profile_pic %}
                    <img src="{{ post.author.profile.profile_pic.url }}" alt="{{ post.author.username }}" class="user-avatar">
                {% else %}
                    <div class="default-avatar">
                        {{ post.author.username|first|upper }}
                    </div>
                {% endif %}
            </a>
            <div class="user-details">
                <a href="{% url 'profile' post.author.username %}" class="user-name">
                    {{ post.author.profile.full_name }}
                </a>
                <div class="post-meta">
                    <span class="post-time">{{ post.created_at|timesince }} ago</span>
                    <span class="post-privacy">
                        <i class="fas fa-globe-americas"></i>
                        Public
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Post Options Menu -->
        <div class="post-options">
            <button class="post-menu-btn" onclick="window.togglePostMenu('{{ post.id }}')">
                <i class="fas fa-ellipsis-h"></i>
            </button>
            <div class="post-menu-dropdown" id="postMenu-{{ post.id }}">
                {% if post.author == request.user %}
                    <button class="menu-item" onclick="window.editPost('{{ post.id }}')">
                        <i class="fas fa-edit"></i>
                        <span>Edit Post</span>
                    </button>
                    <button class="menu-item" onclick="window.deletePost('{{ post.id }}')">
                        <i class="fas fa-trash"></i>
                        <span>Delete Post</span>
                    </button>
                    <div class="menu-divider"></div>
                {% endif %}
                <button class="menu-item" onclick="window.repost('{{ post.id }}')">
                    <i class="fas fa-retweet"></i>
                    <span>Repost</span>
                </button>
                <button class="menu-item" onclick="window.quotePost('{{ post.id }}')">
                    <i class="fas fa-quote-left"></i>
                    <span>Quote Post</span>
                </button>
                <button class="menu-item" onclick="window.savePost('{{ post.id }}')">
                    <i class="fas fa-bookmark"></i>
                    <span>Save Post</span>
                </button>
                <button class="menu-item" onclick="window.copyPostLink('{{ post.id }}')">
                    <i class="fas fa-link"></i>
                    <span>Copy Link</span>
                </button>
                <button class="menu-item" onclick="window.reportPost('{{ post.id }}')">
                    <i class="fas fa-flag"></i>
                    <span>Report Post</span>
                </button>
                {% if post.author != request.user %}
                    <div class="menu-divider"></div>
                    <button class="menu-item" onclick="toggleFollow('{{ post.author.id }}', this)">
                        <i class="fas fa-user-plus"></i>
                        <span>Follow {{ post.author.username }}</span>
                    </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Post Content -->
    <div class="post-content">
        {% if post.content %}
            <div class="post-text">
                {{ post.content|safe|linebreaksbr }}
            </div>
        {% endif %}
        
        {% if post.image %}
            <div class="post-media">
                <div class="media-container">
                    <img src="{{ post.image.url }}" 
                         alt="Post image" 
                         class="post-image"
                         onclick="window.openImageModal('{{ post.image.url }}')"
                         loading="lazy">
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Post Stats -->
    <div class="post-stats">
        <div class="stats-left">
            <div class="likes-stat" onclick="showLikesModal('{{ post.id }}')">
                <div class="likes-preview">
                    <i class="fas fa-heart"></i>
                    <span class="like-count">{{ post.likes.count }}</span>
                </div>
            </div>
            <div class="reposts-stat" onclick="showRepostsModal('{{ post.id }}')">
                <div class="reposts-preview">
                    <i class="fas fa-retweet"></i>
                    <span class="repost-count">{{ post.reposts.count }}</span>
                </div>
            </div>
        </div>
        <div class="stats-right">
            <span class="comment-count">{{ post.comments.count }} comments</span>
            <span class="share-count">{{ post.shares.count }} shares</span>
        </div>
    </div>

    <!-- Post Actions - FIXED -->
<div class="post-actions">
    <!-- Like Button -->
    <button class="post-action-btn like-btn {% if request.user in post.likes.all %}liked{% endif %}" 
            data-post-id="{{ post.id }}"
            onclick="window.toggleLike('{{ post.id }}', this, event)">
        <i class="fas fa-heart"></i>
        <span class="action-text">
            {% if request.user in post.likes.all %}Liked{% else %}Like{% endif %}
        </span>
    </button>
    
    <!-- Comment Button -->
    <button class="post-action-btn comment-btn" 
            onclick="window.toggleComments('{{ post.id }}', event)">
        <i class="fas fa-comment"></i>
        <span>Comment</span>
    </button>
    
    <!-- Repost Button with Dropdown - FIXED -->
    <div class="repost-container">
        <button class="post-action-btn repost-btn" 
                onclick="window.handleRepost('{{ post.id }}', event)">
            <i class="fas fa-retweet"></i>
            <span>Repost</span>
        </button>
        <div class="repost-dropdown" id="repostMenu-{{ post.id }}">
            <button class="repost-option" onclick="window.repost('{{ post.id }}', event)">
                <i class="fas fa-retweet"></i>
                <span>Repost</span>
            </button>
            <button class="repost-option" onclick="window.quotePost('{{ post.id }}', event)">
                <i class="fas fa-quote-left"></i>
                <span>Quote Post</span>
            </button>
        </div>
    </div>
    
    <!-- Share Button with Dropdown - FIXED -->
    <div class="share-container">
        <button class="post-action-btn share-btn" 
                onclick="window.toggleShareMenu('{{ post.id }}', event)">
            <i class="fas fa-share"></i>
            <span>Share</span>
        </button>
        <div class="share-dropdown" id="shareMenu-{{ post.id }}">
            <button class="share-option" onclick="window.shareToFeed('{{ post.id }}', event)">
                <i class="fas fa-newspaper"></i>
                <span>Share to Feed</span>
            </button>
            <button class="share-option" onclick="window.shareToMessage('{{ post.id }}', event)">
                <i class="fas fa-envelope"></i>
                <span>Send in Message</span>
            </button>
            <button class="share-option" onclick="window.shareToStory('{{ post.id }}', event)">
                <i class="fas fa-camera"></i>
                <span>Share to Story</span>
            </button>
            <div class="share-divider"></div>
            <button class="share-option" onclick="window.copyPostLink('{{ post.id }}', event)">
                <i class="fas fa-link"></i>
                <span>Copy Link</span>
            </button>
        </div>
    </div>
</div>


    <!-- Comments Section -->
    <div class="comments-section" id="commentsSection-{{ post.id }}" style="display: none;">
        <!-- Add Comment Form -->
        <div class="add-comment-form">
            <div class="comment-avatar">
                {% if user.profile.profile_pic %}
                    <img src="{{ user.profile.profile_pic.url }}" alt="Profile" class="user-avatar small">
                {% else %}
                    <div class="default-avatar small">
                        {{ user.username|first|upper }}
                    </div>
                {% endif %}
            </div>
            <div class="comment-input-container">
                <div class="comment-input-wrapper">
                    <textarea class="comment-input" 
                              placeholder="Write a comment..." 
                              id="commentInput-{{ post.id }}"
                              onkeydown="handleCommentKeydown(event, '{{ post.id }}')"></textarea>
                </div>
                <button class="comment-submit-btn" onclick="window.submitComment('{{ post.id }}')" type="button">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <!-- Comments List -->
        <div class="comments-list" id="commentsList-{{ post.id }}">
            {% for comment in post.comments.all|slice:":3"|dictsortreversed:"created_at" %}
            <div class="comment" data-comment-id="{{ comment.id }}">
                <div class="comment-avatar">
                    {% if comment.user.profile.profile_pic %}
                        <img src="{{ comment.user.profile.profile_pic.url }}" alt="{{ comment.user.username }}">
                    {% else %}
                        <div class="comment-avatar-default">
                            {{ comment.user.username|first|upper }}
                        </div>
                    {% endif %}
                </div>
                <div class="comment-content">
                    <div class="comment-header">
                        <strong>{{ comment.user.profile.full_name|default:comment.user.username }}</strong>
                        <span class="comment-time">{{ comment.created_at|timesince }} ago</span>
                    </div>
                    <div class="comment-text">{{ comment.content }}</div>
                </div>
            </div>
            {% empty %}
            <div class="no-comments">No comments yet</div>
            {% endfor %}
            
            {% if post.comments.count > 3 %}
                <button class="load-more-comments" onclick="loadMoreComments('{{ post.id }}')">
                    Load {{ post.comments.count|add:"-3" }} more comments
                </button>
            {% endif %}
        </div>
    </div>
</div>

<style>
/* Post Card Styles */
.post-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 16px;
    padding: 16px;
    border: 1px solid #e1e5e9;
}

/* Repost Header */
.repost-header {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #65676b;
    font-size: 13px;
    margin-bottom: 12px;
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 8px;
}

.repost-header a {
    color: #FF9933;
    font-weight: 600;
    text-decoration: none;
}

.repost-header a:hover {
    text-decoration: underline;
}

/* Post Header */
.post-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
}

.post-user-info {
    display: flex;
    gap: 12px;
    align-items: flex-start;
}

.user-avatar, .default-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.default-avatar {
    background: #FF9933;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 16px;
}

.user-details {
    flex: 1;
}

.user-name {
    font-weight: 600;
    color: #1c1e21;
    text-decoration: none;
    font-size: 15px;
}

.user-name:hover {
    text-decoration: underline;
}

.post-meta {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-top: 2px;
}

.post-time, .post-privacy {
    color: #65676b;
    font-size: 13px;
}

/* Post Options */
.post-options {
    position: relative;
}

.post-menu-btn {
    background: none;
    border: none;
    padding: 8px;
    border-radius: 50%;
    cursor: pointer;
    color: #65676b;
    transition: all 0.3s ease;
}

.post-menu-btn:hover {
    background: #f0f2f5;
    color: #FF9933;
}

.post-menu-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    min-width: 200px;
    z-index: 1000;
    display: none;
    padding: 8px 0;
}

.post-menu-dropdown.active {
    display: block;
}

.menu-item {
    width: 100%;
    padding: 12px 16px;
    border: none;
    background: none;
    text-align: left;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
    color: #1c1e21;
    transition: background 0.3s ease;
}

.menu-item:hover {
    background: #f0f2f5;
    color: #FF9933;
}

.menu-divider {
    height: 1px;
    background: #e1e5e9;
    margin: 4px 0;
}

/* Post Content */
.post-content {
    margin-bottom: 12px;
}

.post-text {
    font-size: 15px;
    line-height: 1.4;
    color: #1c1e21;
    margin-bottom: 12px;
    white-space: pre-line;
}

.post-media {
    margin-top: 12px;
}

.media-container {
    border-radius: 8px;
    overflow: hidden;
}

.post-image {
    max-width: 100%;
    max-height: 400px;
    object-fit: contain;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.post-image:hover {
    transform: scale(1.02);
}

/* Post Stats */
.post-stats {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #e1e5e9;
    margin-bottom: 8px;
    color: #65676b;
    font-size: 14px;
}

.stats-left {
    display: flex;
    gap: 16px;
}

.likes-stat, .reposts-stat {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background 0.3s ease;
}

.likes-stat:hover, .reposts-stat:hover {
    background: #f0f2f5;
}

.stats-right {
    display: flex;
    gap: 16px;
}

/* Post Actions */
.post-actions {
    display: flex;
    justify-content: space-around;
    padding: 8px 0;
    border-top: 1px solid #e1e5e9;
}

.post-action-btn {
    background: none;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #65676b;
    transition: all 0.3s ease;
    font-weight: 500;
}

.post-action-btn:hover {
    background: #f0f2f5;
    color: #FF9933;
}

.like-btn.liked {
    color: #e74c3c;
}

.like-btn.liked .action-text {
    color: #e74c3c;
}


/* Repost & Share Dropdown Styles - FIXED */
.repost-container, .share-container {
    position: relative;
    display: inline-block;
}

.repost-dropdown, .share-dropdown {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    min-width: 180px;
    z-index: 9999;
    padding: 8px 0;
    margin-bottom: 8px;
    display: none;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.repost-dropdown.show, .share-dropdown.show {
    display: block;
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(-5px);
}

.repost-option, .share-option {
    width: 100%;
    padding: 12px 16px;
    border: none;
    background: none;
    text-align: left;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    color: #1c1e21;
    transition: all 0.3s ease;
    font-weight: 500;
}

.repost-option:hover, .share-option:hover {
    background: #f0f2f5;
    color: #FF9933;
}

.repost-option i, .share-option i {
    width: 16px;
    text-align: center;
    color: #65676b;
}

.repost-option:hover i, .share-option:hover i {
    color: #FF9933;
}

.share-divider {
    height: 1px;
    background: #e1e5e9;
    margin: 6px 0;
}

/* Ensure dropdowns are above everything */
.post-actions {
    position: relative;
    z-index: 1;
}

.repost-container, .share-container {
    z-index: 9998;
}


/* Comments Section */
.comments-section {
    margin-top: 16px;
    border-top: 1px solid #e1e5e9;
    padding-top: 16px;
}

.add-comment-form {
    display: flex;
    gap: 12px;
    align-items: flex-start;
    margin-bottom: 16px;
}

.comment-input-container {
    flex: 1;
    display: flex;
    gap: 8px;
    align-items: flex-end;
}

.comment-input-wrapper {
    flex: 1;
}

.comment-input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #e1e5e9;
    border-radius: 20px;
    resize: none;
    font-size: 14px;
    font-family: inherit;
    min-height: 40px;
    max-height: 120px;
}

.comment-input:focus {
    outline: none;
    border-color: #FF9933;
}

.comment-submit-btn {
    background: #FF9933;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    cursor: pointer;
    transition: background 0.3s ease;
}

.comment-submit-btn:hover {
    background: #e6851a;
}

/* Comments List */
.comments-list {
    max-height: 400px;
    overflow-y: auto;
}

.comment {
    display: flex;
    gap: 12px;
    padding: 12px;
    border-radius: 8px;
    transition: background 0.3s ease;
    margin-bottom: 8px;
}

.comment:hover {
    background: #f8f9fa;
}

.comment-avatar, .comment-avatar-default {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
}

.comment-avatar-default {
    background: #FF9933;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 12px;
}

.comment-content {
    flex: 1;
}

.comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.comment-header strong {
    font-size: 14px;
    color: #1c1e21;
}

.comment-time {
    font-size: 12px;
    color: #65676b;
}

.comment-text {
    font-size: 14px;
    color: #1c1e21;
    line-height: 1.4;
}

.no-comments {
    text-align: center;
    padding: 20px;
    color: #8e8e93;
    font-style: italic;
}

.load-more-comments {
    width: 100%;
    padding: 12px;
    background: #f8f9fa;
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    color: #FF9933;
    font-weight: 600;
    cursor: pointer;
    margin-top: 8px;
    transition: all 0.3s ease;
}

.load-more-comments:hover {
    background: #FF9933;
    color: white;
    border-color: #FF9933;
}

/* Responsive */
@media (max-width: 768px) {
    .post-card {
        padding: 12px;
        margin-bottom: 12px;
    }
    
    .post-actions {
        gap: 4px;
    }
    
    .post-action-btn {
        padding: 8px 12px;
        font-size: 13px;
    }
    
    .comment {
        padding: 8px;
    }
    
    .repost-dropdown, .share-dropdown {
        left: 0;
        transform: none;
        right: 0;
        margin: 0 auto;
        width: 200px;
    }
}
</style>

<script>
// Comment Functions
function handleCommentKeydown(event, postId) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        window.submitComment(postId);
    }
}

// Enhanced Comment Submission
window.submitComment = async function(postId) {
    const input = document.getElementById(`commentInput-${postId}`);
    const content = input.value.trim();
    
    if (!content) {
        window.showGlobalNotification('Please enter a comment', 'error');
        return;
    }

    try {
        const csrfToken = getCSRFToken();
        const response = await fetch('/api/comments/add/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                post_id: postId,
                comment: content
            })
        });

        if (response.ok) {
            const data = await response.json();
            input.value = '';
            window.showGlobalNotification('Comment posted!', 'success');
            
            // Add new comment at the TOP
            addNewCommentToDOM(postId, data.comment);
            
            // Update comment count
            updateCommentCount(postId, 1);
        }
    } catch (error) {
        console.error('Comment error:', error);
        window.showGlobalNotification('Error posting comment', 'error');
    }
};

// Add new comment at the TOP
function addNewCommentToDOM(postId, comment) {
    const commentsList = document.getElementById(`commentsList-${postId}`);
    const noComments = commentsList.querySelector('.no-comments');
    
    // Remove "No comments" message if exists
    if (noComments) {
        noComments.remove();
    }
    
    // Create new comment element
    const commentElement = document.createElement('div');
    commentElement.className = 'comment';
    commentElement.dataset.commentId = comment.id;
    commentElement.innerHTML = `
        <div class="comment-avatar">
            ${comment.user.avatar ? 
                `<img src="${comment.user.avatar}" alt="${comment.user.name}">` :
                `<div class="comment-avatar-default">${comment.user.name.charAt(0).toUpperCase()}</div>`
            }
        </div>
        <div class="comment-content">
            <div class="comment-header">
                <strong>${comment.user.name}</strong>
                <span class="comment-time">Just now</span>
            </div>
            <div class="comment-text">${comment.content}</div>
        </div>
    `;
    
    // Insert at the TOP (before load more button if exists)
    const loadMoreBtn = commentsList.querySelector('.load-more-comments');
    if (loadMoreBtn) {
        commentsList.insertBefore(commentElement, loadMoreBtn);
    } else {
        commentsList.insertBefore(commentElement, commentsList.firstChild);
    }
}

// Update comment count
function updateCommentCount(postId, increment = 1) {
    const commentCountElement = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCountElement) {
        const currentCount = parseInt(commentCountElement.textContent) || 0;
        commentCountElement.textContent = `${currentCount + increment} comments`;
    }
}

// Load more comments function
window.loadMoreComments = async function(postId) {
    try {
        const commentsList = document.getElementById(`commentsList-${postId}`);
        const currentComments = commentsList.querySelectorAll('.comment').length - 1; // Exclude load more button
        
        const response = await fetch(`/api/comments/${postId}/?offset=${currentComments}`);
        if (response.ok) {
            const data = await response.json();
            
            // Add new comments
            data.comments.forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.className = 'comment';
                commentElement.dataset.commentId = comment.id;
                commentElement.innerHTML = `
                    <div class="comment-avatar">
                        ${comment.user.avatar ? 
                            `<img src="${comment.user.avatar}" alt="${comment.user.name}">` :
                            `<div class="comment-avatar-default">${comment.user.name.charAt(0).toUpperCase()}</div>`
                        }
                    </div>
                    <div class="comment-content">
                        <div class="comment-header">
                            <strong>${comment.user.name}</strong>
                            <span class="comment-time">${comment.created_at}</span>
                        </div>
                        <div class="comment-text">${comment.content}</div>
                    </div>
                `;
                
                // Insert before load more button
                const loadMoreBtn = commentsList.querySelector('.load-more-comments');
                commentsList.insertBefore(commentElement, loadMoreBtn);
            });
            
            // Update or remove load more button
            const loadMoreBtn = commentsList.querySelector('.load-more-comments');
            const remainingComments = data.total_count - (currentComments + data.comments.length);
            
            if (remainingComments > 0) {
                loadMoreBtn.textContent = `Load ${remainingComments} more comments`;
            } else {
                loadMoreBtn.remove();
            }
        }
    } catch (error) {
        console.error('Error loading more comments:', error);
    }
};

// ==================== REPOST SYSTEM - FIXED ====================
window.handleRepost = function(postId, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    console.log('🔄 Handling repost for:', postId);
    window.toggleRepostMenu(postId, event);
};

window.toggleRepostMenu = function(postId, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    console.log('📋 Toggling repost menu for:', postId);
    
    const menu = document.getElementById(`repostMenu-${postId}`);
    if (!menu) {
        console.error('❌ Repost menu not found:', postId);
        return;
    }
    
    // Close all other menus first
    document.querySelectorAll('.repost-dropdown.show, .share-dropdown.show').forEach(m => {
        m.classList.remove('show');
    });
    
    // Toggle current menu
    const isVisible = menu.classList.contains('show');
    
    if (isVisible) {
        menu.classList.remove('show');
        console.log('✅ Repost menu hidden');
    } else {
        menu.classList.add('show');
        console.log('✅ Repost menu shown');
    }
};

window.repost = async function(postId, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    try {
        console.log('🔄 Reposting post:', postId);
        
        const csrfToken = getCSRFToken();
        if (!csrfToken) {
            window.showGlobalNotification('Security token missing', 'error');
            return;
        }

        const response = await fetch(`/api/posts/${postId}/repost/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
            }
        });

        if (response.ok) {
            const data = await response.json();
            window.showGlobalNotification('✅ Reposted successfully!', 'success');
            
            // Close menu
            const menu = document.getElementById(`repostMenu-${postId}`);
            if (menu) menu.classList.remove('show');
            
            // Reload after 1 second to show changes
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            throw new Error('Repost failed');
        }
    } catch (error) {
        console.error('❌ Repost error:', error);
        window.showGlobalNotification('Repost feature coming soon!', 'info');
        
        // Close menu on error too
        const menu = document.getElementById(`repostMenu-${postId}`);
        if (menu) menu.classList.remove('show');
    }
};

window.quotePost = function(postId, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    console.log('💬 Quote post for:', postId);
    window.showGlobalNotification('Quote post feature coming soon!', 'info');
    
    // Close menu
    const menu = document.getElementById(`repostMenu-${postId}`);
    if (menu) menu.classList.remove('show');
};

// ==================== SHARE SYSTEM - FIXED ====================
window.toggleShareMenu = function(postId, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    console.log('📤 Toggling share menu for:', postId);
    
    const menu = document.getElementById(`shareMenu-${postId}`);
    if (!menu) {
        console.error('❌ Share menu not found:', postId);
        return;
    }
    
    // Close all other menus first
    document.querySelectorAll('.repost-dropdown.show, .share-dropdown.show').forEach(m => {
        m.classList.remove('show');
    });
    
    // Toggle current menu
    const isVisible = menu.classList.contains('show');
    
    if (isVisible) {
        menu.classList.remove('show');
        console.log('✅ Share menu hidden');
    } else {
        menu.classList.add('show');
        console.log('✅ Share menu shown');
    }
};

// Share functions - FIXED
window.shareToFeed = function(postId, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    window.showGlobalNotification('Share to feed feature coming soon!', 'info');
    
    // Close menu
    const menu = document.getElementById(`shareMenu-${postId}`);
    if (menu) menu.classList.remove('show');
};

window.shareToMessage = function(postId, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    window.showGlobalNotification('Share to message feature coming soon!', 'info');
    
    // Close menu
    const menu = document.getElementById(`shareMenu-${postId}`);
    if (menu) menu.classList.remove('show');
};

window.shareToStory = function(postId, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    window.showGlobalNotification('Share to story feature coming soon!', 'info');
    
    // Close menu
    const menu = document.getElementById(`shareMenu-${postId}`);
    if (menu) menu.classList.remove('show');
};

window.copyPostLink = function(postId, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    const postUrl = `${window.location.origin}/post/${postId}/`;
    navigator.clipboard.writeText(postUrl).then(() => {
        window.showGlobalNotification('✅ Link copied to clipboard!', 'success');
    }).catch(() => {
        window.showGlobalNotification('❌ Failed to copy link', 'error');
    });
    
    // Close menu
    const menu = document.getElementById(`shareMenu-${postId}`);
    if (menu) menu.classList.remove('show');
};

// Close dropdowns when clicking outside - FIXED
document.addEventListener('click', function(event) {
    // Check if click is outside any dropdown
    if (!event.target.closest('.repost-container') && !event.target.closest('.share-container')) {
        document.querySelectorAll('.repost-dropdown.show, .share-dropdown.show').forEach(menu => {
            menu.classList.remove('show');
        });
    }
});

// Also close on escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        document.querySelectorAll('.repost-dropdown.show, .share-dropdown.show').forEach(menu => {
            menu.classList.remove('show');
        });
    }
});
</script>
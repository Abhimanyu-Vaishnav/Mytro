{% extends 'core/base.html' %}
{% load static %}

{% block title %}Feed - Mytro{% endblock %}

{% block content %}
<div class="feed-container">
    <!-- Left Sidebar -->
    <div class="sidebar left-sidebar">


        <!-- Quick Actions -->
        <div class="quick-actions-card">
            <h4 class="card-title">Quick Actions</h4>
            <div class="action-buttons">
                <button class="action-btn primary-action" onclick="window.openCreatePostModal()">
                    <i class="fas fa-plus"></i>
                    <span>Create Post</span>
                </button>
                <button class="action-btn secondary-action" onclick="openStoryCreator()">
                    <i class="fas fa-camera"></i>
                    <span>Add Story</span>
                </button>
                <button class="action-btn secondary-action" onclick="window.openLiveStream()">
                    <i class="fas fa-video"></i>
                    <span>Go Live</span>
                </button>
            </div>
        </div>

        <!-- Enhanced Suggestions -->
        <div class="suggestions-card">
            <div class="card-header">
                <h4 class="card-title">People You May Know</h4>
                <button class="refresh-btn" onclick="window.refreshSuggestions()" title="Refresh suggestions">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            
            <div class="suggestions-list" id="suggestionsList">
                {% for suggested_user in suggestions %}
                <div class="suggestion-item" data-user-id="{{ suggested_user.id }}">
                    <div class="suggestion-user">
                        <a href="{% url 'profile' suggested_user.username %}" class="user-avatar-link">
                            {% if suggested_user.profile.profile_pic %}
                                <img src="{{ suggested_user.profile.profile_pic.url }}" alt="{{ suggested_user.username }}" class="user-avatar suggestion-avatar">
                            {% else %}
                                <div class="default-avatar suggestion-avatar">
                                    {{ suggested_user.username|first|upper }}
                                </div>
                            {% endif %}
                        </a>
                        
                        <div class="user-details">
                            <a href="{% url 'profile' suggested_user.username %}" class="user-name">
                                {{ suggested_user.profile.full_name }}
                            </a>
                            <span class="user-mutual">5 mutual friends</span>
                        </div>
                    </div>
                    
                    <button class="follow-btn {% if suggested_user in user.profile.following.all %}following{% endif %}" 
                            onclick="toggleFollow({{ suggested_user.id }}, this)">
                        {% if suggested_user in user.profile.following.all %}
                            <i class="fas fa-check"></i>
                            Following
                        {% else %}
                            <i class="fas fa-user-plus"></i>
                            Follow
                        {% endif %}
                    </button>
                </div>
                {% empty %}
                <div class="empty-suggestions">
                    <i class="fas fa-users"></i>
                    <p>No suggestions available</p>
                    <button class="btn-secondary small" onclick="refreshSuggestions()">Find More People</button>
                </div>
                {% endfor %}
            </div>
            
            <div class="card-footer">
                <a href="#" class="see-more-link">See More Suggestions</a>
            </div>
        </div>

        <!-- Shortcuts -->
        <div class="shortcuts-card">
            <h4 class="card-title">Your Shortcuts</h4>
            <div class="shortcuts-list">
                <a href="#" class="shortcut-item">
                    <i class="fas fa-users"></i>
                    <span>Groups</span>
                </a>
                <a href="#" class="shortcut-item">
                    <i class="fas fa-calendar"></i>
                    <span>Events</span>
                </a>
                <a href="#" class="shortcut-item">
                    <i class="fas fa-bookmark"></i>
                    <span>Saved</span>
                </a>
                <a href="#" class="shortcut-item">
                    <i class="fas fa-history"></i>
                    <span>Memories</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Main Feed -->
    <div class="main-feed">
        <!-- Create Post Card -->
        <div class="create-post-card">
            <div class="create-post-header">
                {% if user.profile.profile_pic %}
                    <img src="{{ user.profile.profile_pic.url }}" alt="Profile" class="user-avatar">
                {% else %}
                    <div class="default-avatar">
                        {{ user.username|first|upper }}
                    </div>
                {% endif %}
                <div class="post-input-container">
                    <input type="text" 
                           placeholder="What's on your mind, {{ user.profile.full_name }}?" 
                           class="post-input"
                           onclick="window.openCreatePostModal()"
                           readonly>
                </div>
            </div>
            
            <div class="create-post-options">
                <button class="post-option" onclick="window.openCreatePostModal('photo')">
                    <i class="fas fa-image" style="color: #45bd62;"></i>
                    <span>Photo</span>
                </button>
                <button class="post-option" onclick="window.openCreatePostModal('video')">
                    <i class="fas fa-video" style="color: #f5533d;"></i>
                    <span>Video</span>
                </button>
                <button class="post-option" onclick="window.openCreatePostModal('feeling')">
                    <i class="fas fa-smile" style="color: #f7b928;"></i>
                    <span>Feeling</span>
                </button>
                <button class="post-option" onclick="window.openCreatePostModal('poll')">
                    <i class="fas fa-chart-bar" style="color: #1877f2;"></i>
                    <span>Poll</span>
                </button>
            </div>
        </div>

        <!-- Stories Section -->
        <div class="stories-section">
            <div class="stories-header">
                <h3 class="section-title">Stories</h3>
                <button class="see-all-stories" onclick="viewAllStories()">See All</button>
            </div>
            <div class="stories-container" id="storiesContainer">
                <div class="story-item create-story" onclick="openStoryCreator()">
                    <div class="story-avatar">
                        {% if user.profile.profile_pic %}
                            <img src="{{ user.profile.profile_pic.url }}" alt="Profile">
                        {% else %}
                            <div class="default-avatar">
                                {{ user.username|first|upper }}
                            </div>
                        {% endif %}
                        <div class="add-story-icon">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                    <span class="story-label">Create Story</span>
                </div>
                
                <div class="loading-stories">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Loading stories...</span>
                </div>
            </div>
        </div>

        <!-- Posts Feed -->
        <div class="posts-feed" id="postsContainer">
            {% for post in posts %}
                {% include 'core/components/post_card.html' with post=post %}
            {% empty %}
                <div class="empty-feed-state">
                    <div class="empty-feed-icon">
                        <i class="fas fa-newspaper"></i>
                    </div>
                    <h3>Your feed is empty</h3>
                    <p>Start following people or create your first post to see content here.</p>
                    <div class="empty-feed-actions">
                        <button class="btn-primary" onclick="window.openCreatePostModal()">
                            <i class="fas fa-plus"></i>
                            Create First Post
                        </button>
                        <button class="btn-secondary" onclick="findPeople()">
                            <i class="fas fa-user-plus"></i>
                            Find People to Follow
                        </button>
                    </div>
                </div>
            {% endfor %}
            
            <!-- Loading Indicator -->
            <div class="loading-posts" id="loadingPosts" style="display: none;">
                <div class="loading-spinner"></div>
                <span>Loading more posts...</span>
            </div>
            
            <!-- End of Feed -->
            <div class="end-of-feed" id="endOfFeed" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <p>You're all caught up!</p>
                <button class="btn-secondary" onclick="refreshFeed()">Refresh Feed</button>
            </div>
        </div>
    </div>

    <!-- Right Sidebar -->
    <div class="sidebar right-sidebar">
        <!-- Trending Topics -->
        <div class="trending-card">
            <div class="card-header">
                <h4 class="card-title">Trending Topics</h4>
                <i class="fas fa-fire trending-icon"></i>
            </div>
            
            <div class="trending-list">
                <div id="trendingHashtags">
                    <div class="loading-trends">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Loading trending hashtags...</span>
                    </div>
                </div>
            </div>
            
            <div class="card-footer">
                <a href="#" class="see-more-link">See More Trends</a>
            </div>
        </div>

        <!-- Online Friends -->
        <div class="friends-card">
            <div class="card-header">
                <h4 class="card-title">Online Friends</h4>
                <span class="online-count">3 online</span>
            </div>
            
            <div class="friends-list" id="onlineFriendsList">
                <div class="loading-friends">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Loading online friends...</span>
                </div>
            </div>
            
            <div class="card-footer">
                <a href="#" class="see-more-link">View All Friends</a>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="activity-card">
            <div class="card-header">
                <h4 class="card-title">Recent Activity</h4>
            </div>
            
            <div class="activity-list">
                <div class="activity-item">
                    <div class="activity-avatar">
                        <i class="fas fa-heart"></i>
                    </div>
                    <div class="activity-content">
                        <p><strong>Sarah</strong> liked your post</p>
                        <span class="activity-time">2 min ago</span>
                    </div>
                </div>
                
                <div class="activity-item">
                    <div class="activity-avatar">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <div class="activity-content">
                        <p><strong>Mike</strong> started following you</p>
                        <span class="activity-time">1 hour ago</span>
                    </div>
                </div>
                
                <div class="activity-item">
                    <div class="activity-avatar">
                        <i class="fas fa-comment"></i>
                    </div>
                    <div class="activity-content">
                        <p><strong>Emma</strong> commented on your photo</p>
                        <span class="activity-time">3 hours ago</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer Links -->
        <div class="footer-links">
            <div class="links-row">
                <a href="#">Privacy</a>
                <a href="#">Terms</a>
                <a href="#">Advertising</a>
                <a href="#">Cookies</a>
            </div>
            <div class="links-row">
                <a href="#">About</a>
                <a href="#">Blog</a>
                <a href="#">Careers</a>
                <a href="#">Help</a>
            </div>
            <div class="copyright">
                Mytro © 2024. All rights reserved.
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Feed-specific JavaScript
let feedCurrentPage = 1;
let feedIsLoading = false;
let feedHasMorePosts = true;

// Initialize feed functionality
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        initializeFeed();
        setupInfiniteScroll();
        loadStories();
        loadOnlineFriends();
        loadTrendingHashtags();
    }, 500);
});

// Load stories
async function loadStories() {
    try {
        const response = await fetch('/api/stories/');
        if (response.ok) {
            const data = await response.json();
            displayStories(data.stories);
        } else {
            displayStories([]);
        }
    } catch (error) {
        console.error('Error loading stories:', error);
        displayStories([]);
    }
}

function displayStories(stories) {
    const container = document.getElementById('storiesContainer');
    const createStory = container.querySelector('.create-story');
    const loading = container.querySelector('.loading-stories');
    
    if (loading) loading.remove();
    
    // Remove existing story items (except create story)
    container.querySelectorAll('.story-item:not(.create-story)').forEach(item => item.remove());
    
    if (!stories || stories.length === 0) {
        return;
    }
    
    // Display each user's stories
    stories.forEach(userStory => {
        const storyElement = document.createElement('div');
        storyElement.className = 'story-item';
        storyElement.onclick = () => viewUserStories(userStory.user.id);
        
        storyElement.innerHTML = `
            <div class="story-avatar ${userStory.is_viewed ? 'viewed' : 'unviewed'}">
                ${userStory.user.avatar ? 
                    `<img src="${userStory.user.avatar}" alt="${userStory.user.name}">` :
                    `<div class="default-avatar" style="width: 100%; height: 100%; background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 24px; border-radius: 50%;">${userStory.user.name.charAt(0)}</div>`
                }
                ${userStory.story_count > 1 ? `<div class="story-count" style="position: absolute; top: -5px; right: -5px; background: #ff6b35; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; border: 2px solid white;">${userStory.story_count}</div>` : ''}
            </div>
            <span class="story-user">${userStory.user.name.split(' ')[0]}</span>
        `;
        
        container.insertBefore(storyElement, createStory.nextSibling);
    });
}

function viewUserStories(userId) {
    openStoryViewer(userId, 'user');
}

function viewStory(storyId) {
    openStoryViewer(storyId, 'story');
}

function openStoryViewer(id, type) {
    // Create story viewer modal
    let modal = document.getElementById('storyViewerModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'storyViewerModal';
        modal.className = 'modal-overlay story-viewer';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        `;
        modal.innerHTML = `
            <div class="story-viewer-container" style="
                width: 400px;
                height: 700px;
                background: #000;
                border-radius: 12px;
                overflow: hidden;
                position: relative;
                box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            ">
                <div class="story-viewer-header" style="
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    padding: 16px;
                    background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, transparent 100%);
                    z-index: 10;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                ">
                    <div class="story-user-info" style="display: flex; align-items: center; gap: 12px;">
                        <img id="storyUserAvatar" src="" alt="" class="story-user-avatar" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid white;">
                        <div class="story-user-details">
                            <span id="storyUserName" style="color: white; font-weight: 600; font-size: 14px; display: block;"></span>
                            <span id="storyTime" style="color: rgba(255,255,255,0.8); font-size: 12px;"></span>
                        </div>
                    </div>
                    <button class="story-close" onclick="closeStoryViewer()" style="
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        width: 32px;
                        height: 32px;
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 18px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">×</button>
                </div>
                <div class="story-progress" style="
                    position: absolute;
                    top: 8px;
                    left: 16px;
                    right: 16px;
                    height: 2px;
                    background: rgba(255,255,255,0.3);
                    border-radius: 1px;
                    z-index: 11;
                ">
                    <div class="progress-bar" id="storyProgress" style="
                        height: 100%;
                        background: white;
                        border-radius: 1px;
                        width: 0%;
                        transition: width 0.1s linear;
                    "></div>
                </div>
                <div class="story-content" id="storyContent" style="
                    width: 100%;
                    height: 100%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    position: relative;
                "></div>
                <div class="story-navigation" style="
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    display: flex;
                ">
                    <button class="story-nav prev" onclick="previousStory()" style="
                        flex: 1;
                        background: transparent;
                        border: none;
                        cursor: pointer;
                        color: transparent;
                    "></button>
                    <button class="story-nav next" onclick="nextStory()" style="
                        flex: 1;
                        background: transparent;
                        border: none;
                        cursor: pointer;
                        color: transparent;
                    "></button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    if (type === 'user') {
        loadUserStories(id);
    } else {
        loadStoryContent(id);
    }
    modal.style.display = 'flex';
}

let currentUserStories = [];
let currentStoryIndex = 0;

async function loadUserStories(userId) {
    try {
        const response = await fetch(`/api/stories/user/${userId}/`);
        if (response.ok) {
            const data = await response.json();
            currentUserStories = data.stories;
            currentStoryIndex = 0;
            if (currentUserStories.length > 0) {
                displayStoryContent(currentUserStories[0]);
                updateStoryProgress();
            }
        } else {
            // Show sample story for demo
            currentUserStories = [{
                id: 1,
                story_type: 'text',
                text_content: 'Sample Story!',
                background_color: '#ff6b35',
                user: { name: 'Demo User', avatar: null },
                created_at: 'Just now'
            }];
            currentStoryIndex = 0;
            displayStoryContent(currentUserStories[0]);
        }
    } catch (error) {
        console.error('Error loading user stories:', error);
        closeStoryViewer();
    }
}

function updateStoryProgress() {
    const progressBar = document.getElementById('storyProgress');
    if (progressBar && currentUserStories.length > 0) {
        const progress = ((currentStoryIndex + 1) / currentUserStories.length) * 100;
        progressBar.style.width = `${progress}%`;
    }
}

async function loadStoryContent(storyId) {
    try {
        const response = await fetch(`/api/stories/${storyId}/`);
        if (response.ok) {
            const story = await response.json();
            displayStoryContent(story);
        } else {
            // Show sample story for demo
            const sampleStory = {
                id: storyId,
                story_type: 'text',
                text_content: 'This is a sample story!',
                background_color: '#ff6b35',
                user: {
                    name: 'Sample User',
                    avatar: null
                },
                created_at: '2 hours ago'
            };
            displayStoryContent(sampleStory);
        }
    } catch (error) {
        console.error('Error loading story:', error);
        // Show sample story on error
        const sampleStory = {
            id: storyId,
            story_type: 'text',
            text_content: 'Sample Story Content',
            background_color: '#42b883',
            user: {
                name: 'Demo User',
                avatar: null
            },
            created_at: 'Just now'
        };
        displayStoryContent(sampleStory);
    }
}

function displayStoryContent(story) {
    const avatar = document.getElementById('storyUserAvatar');
    if (story.user.avatar) {
        avatar.src = story.user.avatar;
        avatar.style.display = 'block';
    } else {
        // Create default avatar
        const defaultAvatar = document.createElement('div');
        defaultAvatar.style.cssText = `
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            border: 2px solid white;
        `;
        defaultAvatar.textContent = story.user.name.charAt(0);
        avatar.parentNode.replaceChild(defaultAvatar, avatar);
    }
    
    document.getElementById('storyUserName').textContent = story.user.name;
    document.getElementById('storyTime').textContent = story.created_at;
    
    const content = document.getElementById('storyContent');
    if (story.story_type === 'text') {
        content.innerHTML = `
            <div class="text-story" style="
                width: 100%;
                height: 100%;
                background: ${story.background_color};
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 40px;
                box-sizing: border-box;
            ">
                <p style="
                    color: white;
                    font-size: 24px;
                    font-weight: 600;
                    text-align: center;
                    margin: 0;
                    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    font-family: ${story.font_family || 'Inter'};
                ">${story.text_content}</p>
            </div>
        `;
    } else if (story.story_type === 'image') {
        content.innerHTML = `
            <img src="${story.image}" alt="Story" style="
                width: 100%;
                height: 100%;
                object-fit: cover;
            ">
            ${story.caption ? `<div class="story-caption" style="position: absolute; bottom: 60px; left: 20px; right: 20px; background: rgba(0,0,0,0.5); color: white; padding: 12px; border-radius: 8px; font-size: 16px;">${story.caption}</div>` : ''}
        `;
    } else if (story.story_type === 'video') {
        content.innerHTML = `
            <video autoplay muted loop style="
                width: 100%;
                height: 100%;
                object-fit: cover;
            ">
                <source src="${story.video}" type="video/mp4">
            </video>
            ${story.caption ? `<div class="story-caption" style="position: absolute; bottom: 60px; left: 20px; right: 20px; background: rgba(0,0,0,0.5); color: white; padding: 12px; border-radius: 8px; font-size: 16px;">${story.caption}</div>` : ''}
        `;
    }
    
    // Add delete button if own story
    if (story.can_delete) {
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteBtn.className = 'story-delete-btn';
        deleteBtn.style.cssText = `
            position: absolute;
            top: 16px;
            left: 16px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        `;
        deleteBtn.onclick = () => deleteStory(story.id);
        content.appendChild(deleteBtn);
    }
    
    // Start progress animation
    const progressBar = document.getElementById('storyProgress');
    progressBar.style.width = '0%';
    setTimeout(() => {
        progressBar.style.transition = 'width 5s linear';
        progressBar.style.width = '100%';
    }, 100);
    
    // Auto-advance story after 5 seconds
    setTimeout(() => {
        nextStory();
    }, 5000);
}

async function deleteStory(storyId) {
    if (!confirm('Delete this story?')) return;
    
    try {
        const response = await fetch(`/api/stories/${storyId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        if (response.ok) {
            window.showGlobalNotification('Story deleted', 'success');
            closeStoryViewer();
            loadStories();
        }
    } catch (error) {
        console.error('Error deleting story:', error);
    }
}

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}

function closeStoryViewer() {
    const modal = document.getElementById('storyViewerModal');
    if (modal) modal.style.display = 'none';
}

function previousStory() {
    if (currentStoryIndex > 0) {
        currentStoryIndex--;
        displayStoryContent(currentUserStories[currentStoryIndex]);
    } else {
        closeStoryViewer();
    }
}

function nextStory() {
    if (currentStoryIndex < currentUserStories.length - 1) {
        currentStoryIndex++;
        displayStoryContent(currentUserStories[currentStoryIndex]);
    } else {
        closeStoryViewer();
    }
}

function viewAllStories() {
    window.showGlobalNotification('View all stories', 'info');
}

function initializeFeed() {
    // Load initial posts if needed
    if (document.querySelectorAll('.post-card').length === 0) {
        loadMorePosts();
    }
}

function setupInfiniteScroll() {
    window.addEventListener('scroll', throttle(function() {
        const scrollPosition = window.innerHeight + window.pageYOffset;
        const pageHeight = document.documentElement.scrollHeight;
        const threshold = 500;

        if (scrollPosition >= pageHeight - threshold && !feedIsLoading && feedHasMorePosts) {
            loadMorePosts();
        }
    }, 200));
}

async function loadMorePosts() {
    if (feedIsLoading || !feedHasMorePosts) return;
    
    feedIsLoading = true;
    const loadingIndicator = document.getElementById('loadingPosts');
    loadingIndicator.style.display = 'flex';
    
    try {
        const response = await fetch(`/api/load_more_posts/?offset=${currentPage * 10}`);
        if (response.ok) {
            const data = await response.json();
            
            if (data.posts && data.posts.length > 0) {
                appendPosts(data.posts);
                feedCurrentPage++;
            } else {
                feedHasMorePosts = false;
                document.getElementById('endOfFeed').style.display = 'block';
            }
        }
    } catch (error) {
        console.error('Error loading more posts:', error);
        showNotification('Error loading posts', 'error');
    } finally {
        feedIsLoading = false;
        loadingIndicator.style.display = 'none';
    }
}

function appendPosts(posts) {
    const postsContainer = document.getElementById('postsContainer');
    const endOfFeed = document.getElementById('endOfFeed');
    
    if (endOfFeed.style.display !== 'none') {
        endOfFeed.style.display = 'none';
    }
    
    posts.forEach(post => {
        const postElement = createPostElement(post);
        postsContainer.insertBefore(postElement, document.getElementById('loadingPosts'));
    });
}

function createPostElement(post) {
    // This would create a post element from template
    // For now, we'll create a simple placeholder
    const div = document.createElement('div');
    div.className = 'post-card';
    div.innerHTML = `
        <div class="post-header">
            <div class="post-user-info">
                <div class="user-avatar small"></div>
                <div class="user-details">
                    <span class="user-name">${post.author.name}</span>
                    <span class="post-time">Just now</span>
                </div>
            </div>
        </div>
        <div class="post-content">
            <p>${post.content}</p>
        </div>
    `;
    return div;
}

// Enhanced follow functionality
async function toggleFollow(userId, button) {
    try {
        button.disabled = true;
        const originalHTML = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        const response = await fetch(`/api/follow/${userId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        });

        if (response.ok) {
            const data = await response.json();
            
            if (data.following) {
                button.innerHTML = '<i class="fas fa-check"></i> Following';
                button.classList.add('following');
                showNotification(`You started following ${data.username}`);
                
                // Remove from suggestions after following
                const suggestionItem = button.closest('.suggestion-item');
                suggestionItem.style.opacity = '0.5';
                setTimeout(() => {
                    suggestionItem.style.transition = 'all 0.3s ease';
                    suggestionItem.style.height = '0';
                    suggestionItem.style.opacity = '0';
                    suggestionItem.style.margin = '0';
                    suggestionItem.style.padding = '0';
                    
                    setTimeout(() => {
                        suggestionItem.remove();
                        checkEmptySuggestions();
                    }, 300);
                }, 1000);
            } else {
                button.innerHTML = '<i class="fas fa-user-plus"></i> Follow';
                button.classList.remove('following');
                showNotification(`You unfollowed ${data.username}`);
            }
        }
    } catch (error) {
        console.error('Error following user:', error);
        showNotification('Error following user', 'error');
        button.innerHTML = originalHTML;
    } finally {
        button.disabled = false;
    }
}

function checkEmptySuggestions() {
    const suggestionsList = document.getElementById('suggestionsList');
    const suggestionItems = suggestionsList.querySelectorAll('.suggestion-item');
    
    if (suggestionItems.length === 0) {
        suggestionsList.innerHTML = `
            <div class="empty-suggestions">
                <i class="fas fa-check-circle"></i>
                <p>You're following all suggestions!</p>
                <button class="btn-secondary small" onclick="refreshSuggestions()">Find More People</button>
            </div>
        `;
    }
}

async function refreshSuggestions() {
    const refreshBtn = document.querySelector('.refresh-btn');
    const suggestionsList = document.getElementById('suggestionsList');
    
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    refreshBtn.disabled = true;
    
    // Show loading state
    suggestionsList.innerHTML = `
        <div class="loading-suggestions">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Finding new suggestions...</p>
        </div>
    `;
    
    try {
        const response = await fetch('/api/suggested_users/');
        if (response.ok) {
            const data = await response.json();
            displayNewSuggestions(data.users);
        }
    } catch (error) {
        console.error('Error refreshing suggestions:', error);
        showNotification('Error refreshing suggestions', 'error');
    } finally {
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
        refreshBtn.disabled = false;
    }
}

function displayNewSuggestions(users) {
    const suggestionsList = document.getElementById('suggestionsList');
    
    if (!users || users.length === 0) {
        suggestionsList.innerHTML = `
            <div class="empty-suggestions">
                <i class="fas fa-users"></i>
                <p>No suggestions available right now</p>
                <button class="btn-secondary small" onclick="refreshSuggestions()">Try Again</button>
            </div>
        `;
        return;
    }
    
    suggestionsList.innerHTML = users.map(user => `
        <div class="suggestion-item" data-user-id="${user.id}">
            <div class="suggestion-user">
                <a href="/profile/${user.username}/" class="user-avatar-link">
                    ${user.avatar ? 
                        `<img src="${user.avatar}" alt="${user.username}" class="user-avatar suggestion-avatar">` :
                        `<div class="default-avatar suggestion-avatar">${user.name.charAt(0)}</div>`
                    }
                </a>
                
                <div class="user-details">
                    <a href="/profile/${user.username}/" class="user-name">${user.name}</a>
                    <span class="user-mutual">5 mutual friends</span>
                </div>
            </div>
            
            <button class="follow-btn" onclick="toggleFollow(${user.id}, this)">
                <i class="fas fa-user-plus"></i>
                Follow
            </button>
        </div>
    `).join('');
}

// Remove duplicate function since it's already in main.js

function refreshFeed() {
    window.location.reload();
}

function findPeople() {
    // Navigate to people discovery page
    window.location.href = '/discover/';
}

// Utility function for throttling
// Load online friends
async function loadOnlineFriends() {
    try {
        const response = await fetch('/api/online-users/');
        if (response.ok) {
            const data = await response.json();
            displayOnlineFriends(data.online_users);
        }
    } catch (error) {
        console.error('Error loading online friends:', error);
        displayOnlineFriends([]);
    }
}

// Load trending hashtags
async function loadTrendingHashtags() {
    try {
        const response = await fetch('/api/trending-hashtags/');
        if (response.ok) {
            const data = await response.json();
            displayTrendingHashtags(data.hashtags);
        } else {
            displayTrendingHashtags([
                { tag: 'QuickTrust', count: 245 },
                { tag: 'StartingSmart', count: 189 },
                { tag: 'MytroUpdate', count: 156 },
                { tag: 'TechNews', count: 142 }
            ]);
        }
    } catch (error) {
        console.error('Error loading trending hashtags:', error);
        displayTrendingHashtags([
            { tag: 'QuickTrust', count: 245 },
            { tag: 'StartingSmart', count: 189 },
            { tag: 'MytroUpdate', count: 156 },
            { tag: 'TechNews', count: 142 }
        ]);
    }
}

function displayTrendingHashtags(hashtags) {
    const container = document.getElementById('trendingHashtags');
    if (!container) return;
    
    if (!hashtags || hashtags.length === 0) {
        container.innerHTML = `
            <div class="empty-trends">
                <i class="fas fa-hashtag"></i>
                <p>No trending hashtags</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = hashtags.map((hashtag, index) => `
        <div class="trending-item">
            <span class="trend-rank">${index + 1}</span>
            <div class="trend-info">
                <a href="/hashtag/${hashtag.tag}/" class="trend-topic">#${hashtag.tag}</a>
                <span class="trend-stats">${hashtag.count} posts</span>
            </div>
        </div>
    `).join('');
}

function displayOnlineFriends(users) {
    const friendsList = document.getElementById('onlineFriendsList');
    if (!friendsList) return;
    
    if (!users || users.length === 0) {
        friendsList.innerHTML = `
            <div class="empty-friends" style="text-align: center; padding: 20px; color: #65676b;">
                <i class="fas fa-user-friends" style="font-size: 24px; margin-bottom: 8px;"></i>
                <p>No friends online</p>
            </div>
        `;
        return;
    }
    
    const onlineUsers = users.filter(user => user.is_online);
    const offlineUsers = users.filter(user => !user.is_online);
    
    friendsList.innerHTML = [...onlineUsers, ...offlineUsers].map(user => `
        <div class="friend-item ${user.is_online ? 'online' : 'offline'}" onclick="openChatWith(${user.id})" style="padding: 12px 16px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-radius: 8px; transition: background 0.2s; opacity: ${user.is_online ? '1' : '0.6'};" onmouseover="this.style.background='#f0f2f5'" onmouseout="this.style.background='none'">
            <div class="friend-avatar" style="position: relative;">
                ${user.avatar ? 
                    `<img src="${user.avatar}" alt="${user.name}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` :
                    `<div class="default-avatar" style="width: 40px; height: 40px; border-radius: 50%; background: #ff6b35; color: white; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 600;">${user.name.charAt(0)}</div>`
                }
                ${user.is_online ? '<div class="online-indicator" style="position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; background: #42b883; border: 2px solid white; border-radius: 50%;"></div>' : ''}
            </div>
            <div class="friend-info" style="flex: 1;">
                <span class="friend-name" style="font-weight: 600; color: #1c1e21; font-size: 14px; display: block;">${user.name}</span>
                <div class="friend-status" style="font-size: 12px; color: ${user.is_online ? '#42b883' : '#65676b'};">${user.is_online ? 'Active now' : 'Offline'}</div>
            </div>
            <button class="message-btn" onclick="event.stopPropagation(); startChatWith(${user.id})" style="background: none; border: none; cursor: pointer; padding: 8px; border-radius: 50%; color: #1877f2;" onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='none'">
                <i class="fas fa-comment"></i>
            </button>
        </div>
    `).join('');
    
    // Update online count
    const onlineCount = document.querySelector('.online-count');
    if (onlineCount) {
        const count = onlineUsers.length;
        onlineCount.textContent = `${count} online`;
        onlineCount.style.cssText = 'font-size: 12px; color: #42b883; font-weight: 600;';
    }
}

window.openChatWith = function(userId) {
    window.location.href = `/messages/?user=${userId}`;
};

window.startChatWith = function(userId) {
    window.location.href = `/messages/?user=${userId}`;
};

// Utility function for throttling
function throttle(func, limit) {
    let inThrottle;
    return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    }
}
</script>
{% endblock %}
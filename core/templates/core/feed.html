{% extends "core/base.html" %}
{% load follow_tags %}
{% load static %}

{% block title %}Mytro Feed{% endblock %}

{% block extra_head %}
<style>
  #postBtn {
    position: fixed;
    bottom: 40px;
    right: 40px;
    background-color: #ff7f50;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    box-shadow: 0 6px 12px rgba(255, 127, 80, 0.4);
    color: white;
    font-size: 30px;
    border: none;
    z-index: 1000;
    cursor: pointer;
  }
  #postModal .modal-content { border-radius: 12px; }
  .card { border-radius: 10px; box-shadow: 0 6px 12px rgba(0,0,0,0.05); margin-bottom: 20px; transition: box-shadow 0.3s ease-in-out; }
  .card:hover { box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
  .like-btn, .comment-btn, .edit-btn { color: #ff7f50; text-decoration: none; font-weight: 600; }
  .like-btn:hover, .comment-btn:hover, .edit-btn:hover { text-decoration: underline; }
  .btn-kesri {
    background-color: #ff7f50; color: white; border: none; border-radius: 8px; font-weight: 700; transition: background-color 0.3s;
  }
  .btn-kesri:hover { background-color: #e6733d; }
  .btn-primary { background-color: #ff7f50 !important; border-color: #ff7f50 !important; }
  .btn-primary:hover { background-color: #e6733d !important; border-color: #e6733d !important; }
  .btn-danger { background-color: #d9534f !important; border-color: #d9534f !important; }
  .btn-danger:hover { background-color: #c9302c !important; border-color: #c9302c !important; }
  .suggestion-list { max-height: 400px; overflow-y: auto; }
  .profile-photo, .avatar-fallback {
    width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px; flex-shrink: 0;
  }
  .avatar-fallback {
    background-color: #ff7f50; color: white; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 20px; text-transform: uppercase;
  }
</style>
{% endblock %}

{% block content %}
<h2 class="my-4 text-center">Your Feed</h2>

<div class="row">
  <div class="col-md-8">
    {% if posts %}
      {% for post in posts %}
      <div class="card mb-3">
        <div class="card-body d-flex">
          {% if post.author.profile.photo %}
            <a href="{% url 'profile' post.author.username %}">
              <img src="{{ post.author.profile.photo.url }}" alt="Profile Photo" class="profile-photo"/>
            </a>
          {% else %}
            <a href="{% url 'profile' post.author.username %}">
              <div class="avatar-fallback">{{ post.author.profile.name|default:post.author.username|first }}</div>
            </a>
          {% endif %}
          <div>
            <h5>
              <a href="{% url 'profile' post.author.username %}" style="color:#ff7f50; font-weight:600;">
                {{ post.author.profile.name|default:post.author.username }}
              </a>
            </h5>
            <p>{{ post.content }}</p>
            {% if post.image %}
              <img src="{{ post.image.url }}" alt="Post Image" class="img-fluid rounded mt-3"/>
            {% endif %}
            <div class="mt-3">
              <a href="{% url 'like_post' post.id %}" class="like-btn me-3">Like ({{ post.likes.count }})</a>
              <a href="{% url 'add_comment' post.id %}" class="comment-btn me-3">Comment ({{ post.comments.count }})</a>
              {% if post.author == user %}
                <a href="{% url 'edit_post' post.id %}" class="edit-btn">Edit</a>
              {% endif %}
            </div>
            {% for comment in post.comments.all %}
              <div class="border-top pt-2 mt-2">
                {% if comment.user.profile.photo %}
                  <a href="{% url 'profile' comment.user.username %}">
                    <img src="{{ comment.user.profile.photo.url }}" alt="Commenter Photo" class="profile-photo"/>
                  </a>
                {% else %}
                  <a href="{% url 'profile' comment.user.username %}">
                    <div class="avatar-fallback">{{ comment.user.profile.name|default:comment.user.username|first }}</div>
                  </a>
                {% endif %}
                <strong>
                    <a href="{% url 'profile' comment.user.username %}" style="color:#ff7f50;">
                      {{ comment.user.profile.name|default:comment.user.username }}
                    </a>
                </strong>: {{ comment.content }}
                <br>
                <small class="text-muted">{{ comment.created_at|date:"M d, Y H:i" }}</small>
              </div>
            {% endfor %}
            <small class="text-muted">{{ post.created_at|date:"M d, Y H:i" }}</small>
          </div>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <p class="text-center">No posts to show.</p>
    {% endif %}
  </div>

  <div class="col-md-4">
    <h5 class="mb-3">People You May Know</h5>
    <ul class="list-group suggestion-list">
      {% for user in suggestions %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          {% if user.profile.photo %}
            <a href="{% url 'profile' user.username %}">
              <img src="{{ user.profile.photo.url }}" alt="Profile Photo" class="profile-photo"/>
            </a>
          {% else %}
            <a href="{% url 'profile' user.username %}">
              <div class="avatar-fallback">{{ user.profile.name|default:user.username|first }}</div>
            </a>
          {% endif %}
          <a href="{% url 'profile' user.username %}" class="fw-bold ms-2" style="color:#ff7f50;">
            {{ user.profile.name|default:user.username }}
          </a>
        </div>
        {% if user|user_is_followed:request.user %}
          <form method="post" action="{% url 'unfollow_user' user.username %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-danger">Unfollow</button>
          </form>
        {% else %}
          <form method="post" action="{% url 'follow_user' user.username %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-primary">Follow</button>
          </form>
        {% endif %}
      </li>
      {% empty %}
        <li class="list-group-item">No suggestions available</li>
      {% endfor %}
    </ul>
  </div>
</div>

<button id="postBtn" data-bs-toggle="modal" data-bs-target="#postModal" title="Create New Post">+</button>

<div class="modal fade" id="postModal" tabindex="-1" aria-labelledby="postModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content p-4">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title" id="postModalLabel">Create New Post</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-body pt-0">
          {{ form.content }}
          {{ form.image }}
        </div>
        <div class="modal-footer border-0 pt-0">
          <button type="submit" class="btn btn-kesri">Post</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  var postModal = document.getElementById('postModal')
  postModal.addEventListener('shown.bs.modal', function () {
    postModal.querySelector('textarea, input[type="text"]').focus()
  })
</script>
{% endblock %}

{% extends "core/base.html" %}
{% load follow_tags %}
{% load static %}

{% block title %}Mytro Feed{% endblock %}
{% block extra_head %}
<style>
  /* Your full existing CSS unchanged (not shortened) */
  /* General */
  body {
    background: #fff7f0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  }
  /* Floating post button */
  #postBtn {
    position: fixed;
    bottom: 40px;
    right: 40px;
    background-color: #ff7f50; /* Kesari */
    border-radius: 50%;
    width: 60px;
    height: 60px;
    box-shadow: 0 6px 12px rgba(255, 127, 80, 0.5);
    color: white;
    font-size: 32px;
    border: none;
    z-index: 1000;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: background-color 0.3s;
  }
  #postBtn:hover {
    background-color: #e6733d;
  }
  /* Card styles */
  .card {
    border-radius: 15px;
    box-shadow: 0 5px 18px rgba(255, 127, 80, 0.16);
    margin-bottom: 25px;
    transition: box-shadow 0.3s ease-in-out, transform 0.15s ease-in-out;
  }
  .card:hover {
    box-shadow: 0 14px 40px rgba(255, 127, 80, 0.25);
    transform: translateY(-3px);
  }
  .card-body {
    display: flex;
    gap: 15px;
  }
  /* Profile photos and avatar fallback */
  .profile-photo,
  .avatar-fallback {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
  }
  .avatar-fallback {
    background-color: #ff7f50;
    color: white;
    font-weight: 700;
    font-size: 22px;
    display: flex;
    justify-content: center;
    align-items: center;
    text-transform: uppercase;
  }
  /* User and post text */
  h5 a,
  strong a {
    color: #ff7f50 !important;
    font-weight: 700;
    text-decoration: none;
  }
  h5 a:hover,
  strong a:hover {
    text-decoration: underline;
  }
  p,
  textarea,
  input {
    font-size: 16px;
    margin-top: 8px;
    color: #4a4a4a;
    line-height: 1.4;
  }
  .post-content-view {
    white-space: pre-line;
  }
  .img-fluid {
    border-radius: 15px;
    margin-top: 12px;
    max-height: 400px;
    object-fit: cover;
  }
  /* Post interaction buttons */
  .like-btn,
  .comment-btn,
  .edit-btn {
    color: #ff7f50;
    text-decoration: none;
    font-weight: 700;
    margin-right: 20px;
    cursor: pointer;
    font-size: 15px;
    transition: color 0.3s;
  }
  .like-btn:hover,
  .comment-btn:hover,
  .edit-btn:hover {
    color: #e6733d;
    text-decoration: underline;
  }
  /* Comments */
  .comment-block {
    border-top: 1px solid #f7c9a4;
    padding-top: 12px;
    margin-top: 12px;
    color: #666;
    font-size: 14px;
  }
  .comment-block strong {
    color: #ff7f50;
  }
  /* Date */
  small.text-muted {
    color: #a9725b !important;
    font-size: 13px;
  }
  /* Suggestions panel */
  .suggestion-list {
    max-height: 420px;
    overflow-y: auto;
    box-shadow: 0 5px 12px rgba(255, 127, 80, 0.15);
  }
  .list-group-item {
    border-radius: 15px;
    margin-bottom: 10px;
    padding: 12px 15px;
  }
  .list-group-item.d-flex {
    gap: 12px;
    align-items: center;
  }
  /* Buttons */
  .btn-primary,
  .btn-primary:focus,
  .btn-primary:hover,
  .btn-primary:active,
  .btn-primary:visited {
    background-color: #ff7f50 !important;
    border-color: #ff7f50 !important;
    font-weight: 700;
    transition: background-color 0.3s;
  }
  .btn-primary:hover {
    background-color: #e6733d !important;
    border-color: #e6733d !important;
  }
  .btn-danger,
  .btn-danger:focus,
  .btn-danger:hover,
  .btn-danger:active {
    background-color: #d64535 !important;
    border-color: #d64535 !important;
  }
  .btn-danger:hover {
    background-color: #b03529 !important;
    border-color: #b03529 !important;
  }
  .comment-editable,
  .post-editable {
    width: 100%;
    padding: 8px 10px;
    font-size: 16px;
    border-radius: 10px;
    border: 1.5px solid #ff7f50;
    resize: vertical;
    margin-top: 6px;
  }
  .edit-actions {
    margin-top: 8px;
  }
  .edit-actions button {
    margin-right: 12px;
    font-size: 14px;
  }

  /* New added small style for emoji and attach buttons */
  .emoji-btn,
  .attach-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 18px;
    color: #ff7f50;
    margin-left: 8px;
    vertical-align: middle;
  }

  .card-body h5 {
  margin-bottom: 0.1rem; /* Reduce gap below name */
}
.post-content-wrapper {
  margin-top: 0; /* Or decrease if needed */
}

</style>
<script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.min.js"></script>
{% endblock %}
{% block content %}
<h2 class="my-4 text-center" style="color: #7e4b21">Your Feed</h2>

<div class="row">
  <div class="col-md-8">
    {% if posts %}
      {% for post in posts %}
        <div class="card" data-post-id="{{ post.id }}">
          <div class="card-body">
            {% if post.author.profile.photo %}
              <a href="{% url 'profile' post.author.username %}">
                <img src="{{ post.author.profile.photo.url }}" alt="Profile Photo" class="profile-photo" />
              </a>
            {% else %}
              <a href="{% url 'profile' post.author.username %}">
                <div class="avatar-fallback">{{ post.author.profile.name|default:post.author.username|first }}</div>
              </a>
            {% endif %}
            <div style="flex: 1">
              <h5>
                <a href="{% url 'profile' post.author.username %}">{{ post.author.profile.name|default:post.author.username }}</a>
              </h5>
              <div class="post-content-wrapper">
                <div class="post-content-view" id="post-content-{{ post.id }}">
                  {{ post.content|linebreaksbr }}
                </div>
                <textarea class="post-editable d-none" id="post-edit-{{ post.id }}" rows="3">{{ post.content }}</textarea>
                <div class="edit-actions d-none" id="post-edit-actions-{{ post.id }}">
                  <button class="btn btn-sm btn-primary" onclick="savePostEdit({{ post.id }})">Save</button>
                  <button class="btn btn-sm btn-secondary" onclick="cancelPostEdit({{ post.id }})">Cancel</button>
                </div>
              </div>
              {% if post.image %}
                <img src="{{ post.image.url }}" alt="Post Image" class="img-fluid" />
              {% endif %}
              <div>
                <small class="text-muted">
                  {{ post.created_at|date:"M d, Y H:i" }} {% if post.updated_at and post.updated_at > post.created_at %} (Edited) {% endif %}
                </small>
              </div>

              <div class="mt-3">
                <a href="#" class="like-btn" onclick="likePost({{ post.id }}); return false;">Like ({{ post.likes.count }})</a>
                <a href="#" class="comment-btn" onclick="toggleCommentInput({{ post.id }}); return false;">Comment ({{ post.comments.count }})</a>
                {% if post.author == user %}
                  <a href="#" class="edit-btn" onclick="enablePostEdit({{ post.id }}); return false;">Edit</a>
                  <button class="btn btn-sm btn-outline-primary" onclick="sharePost({{ post.id }})">Share</button>
                {% endif %}
              </div>
              <div id="comments-container-{{ post.id }}" class="mt-3">
                {% for comment in post.comments.all %}
                  <div class="comment-block" id="comment-{{ comment.id }}">
                    {% if comment.user.profile.photo %}
                      <a href="{% url 'profile' comment.user.username %}">
                        <img src="{{ comment.user.profile.photo.url }}" alt="Commenter Photo" class="profile-photo" />
                      </a>
                    {% else %}
                      <a href="{% url 'profile' comment.user.username %}">
                        <div class="avatar-fallback">{{ comment.user.profile.name|default:comment.user.username|first }}</div>
                      </a>
                    {% endif %}
                    <strong><a href="{% url 'profile' comment.user.username %}">{{ comment.user.profile.name|default:comment.user.username }}</a></strong>:
                    <span id="comment-content-{{ comment.id }}">{{ comment.content }}</span>
                    {% if comment.user == user %}
                      <a href="#" class="edit-btn" onclick="enableCommentEdit({{ comment.id }}); return false;">Edit</a>
                    {% endif %}
                    <br />
                    <small class="text-muted">{{ comment.created_at|date:"M d, Y H:i" }}</small>
                    <textarea class="comment-editable d-none" id="comment-edit-{{ comment.id }}" rows="2">{{ comment.content }}</textarea>
                    <div class="edit-actions d-none" id="comment-edit-actions-{{ comment.id }}">
                      <button class="btn btn-sm btn-primary" onclick="saveCommentEdit({{ comment.id }}); return false;">Save</button>
                      <button class="btn btn-sm btn-secondary" onclick="cancelCommentEdit({{ comment.id }}); return false;">Cancel</button>
                    </div>
                  </div>
                {% endfor %}
              </div>

              <div class="mt-3 d-none" id="comment-input-wrapper-{{ post.id }}">
                <form onsubmit="return addComment(event, {{ post.id }});">
                  {% csrf_token %}
                  <textarea name="comment" id="comment-input-{{ post.id }}" class="form-control" placeholder="Add a comment..." rows="2" required></textarea>
                  <button type="button" class="emoji-btn" onclick="toggleEmojiPicker('comment-input-{{ post.id }}')" title="Add Emoji">ðŸ˜Š</button>
                  <button type="button" class="attach-btn" onclick="document.getElementById('comment-photo-{{ post.id }}').click()" title="Attach Photo">ðŸ“Ž</button>
                  <input type="file" id="comment-photo-{{ post.id }}" style="display: none" accept="image/*" onchange="uploadCommentPhoto(event, {{ post.id }})" />
                  <button type="submit" class="btn btn-sm btn-primary mt-2">Post Comment</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-center" style="color: #7e4b21">No posts to show.</p>
    {% endif %}
  </div>

  <div class="col-md-4">
    <h5 class="mb-3" style="color: #7e4b21">People You May Know</h5>
    <ul class="list-group suggestion-list">
      {% for user in suggestions %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            {% if user.profile.photo %}
              <a href="{% url 'profile' user.username %}">
                <img src="{{ user.profile.photo.url }}" alt="Profile Photo" class="profile-photo" />
              </a>
            {% else %}
              <a href="{% url 'profile' user.username %}">
                <div class="avatar-fallback">{{ user.profile.name|default:user.username|first }}</div>
              </a>
            {% endif %}
            <a href="{% url 'profile' user.username %}" class="fw-bold ms-2" style="color: #ff7f50">
              {{ user.profile.name|default:user.username }}
            </a>
          </div>
          {% if user|user_is_followed:request.user %}
            <form method="post" action="{% url 'unfollow_user' user.username %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-danger">Unfollow</button>
            </form>
          {% else %}
            <form method="post" action="{% url 'follow_user' user.username %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-primary">Follow</button>
            </form>
          {% endif %}
        </li>
      {% empty %}
        <li class="list-group-item">No suggestions available</li>
      {% endfor %}
    </ul>
  </div>
</div>

<button id="postBtn" data-bs-toggle="modal" data-bs-target="#postModal" title="Create New Post">
  +
</button>

<div class="modal fade" id="postModal" tabindex="-1" aria-labelledby="postModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content p-4">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title" id="postModalLabel">Create New Post</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" enctype="multipart/form-data" id="post-form">
        {% csrf_token %}
        <div class="modal-body pt-0" style="position: relative">
          {{ form.content }}
          <button type="button" class="emoji-btn" onclick="toggleEmojiPicker('id_content')" title="Add Emoji" style="position: absolute; right: 15px; bottom: 110px">ðŸ˜Š</button>
          {{ form.image }}
          <label for="{{ form.image.id_for_label }}" class="attach-btn" title="Attach Photo" style="cursor: pointer">ðŸ“Ž</label>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button type="submit" class="btn btn-primary">Post</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.min.js"></script>
<script>
  const emojiPickers = {};

  function toggleEmojiPicker(inputId) {
    if (emojiPickers[inputId]) {
      emojiPickers[inputId].toggle();
      return;
    }
    const input = document.getElementById(inputId);
    const picker = new EmojiButton({ position: "top-end" });
    picker.on("emoji", (emoji) => {
      insertAtCursor(input, emoji);
    });
    emojiPickers[inputId] = picker;
    picker.toggle();
  }

  function insertAtCursor(input, textToInsert) {
    const start = input.selectionStart;
    const end = input.selectionEnd;
    const text = input.value;
    input.value = text.slice(0, start) + textToInsert + text.slice(end);
    input.selectionStart = input.selectionEnd = start + textToInsert.length;
    input.focus();
  }

  var postModal = document.getElementById("postModal");
  postModal.addEventListener("shown.bs.modal", function () {
    postModal.querySelector("textarea, input[type='text']").focus();
  });

  function toggleCommentInput(postId) {
    const wrapper = document.getElementById("comment-input-wrapper-" + postId);
    wrapper.classList.toggle("d-none");
    if (!wrapper.classList.contains("d-none")) {
      document.getElementById("comment-input-" + postId).focus();
    }
  }

  function enablePostEdit(postId) {
    document.getElementById("post-content-" + postId).classList.add("d-none");
    document.getElementById("post-edit-" + postId).classList.remove("d-none");
    document.getElementById("post-edit-actions-" + postId).classList.remove("d-none");
  }

  function cancelPostEdit(postId) {
    let editArea = document.getElementById("post-edit-" + postId);
    let viewContent = document.getElementById("post-content-" + postId);
    editArea.classList.add("d-none");
    document.getElementById("post-edit-actions-" + postId).classList.add("d-none");
    viewContent.classList.remove("d-none");
    editArea.value = viewContent.innerText.trim();
  }

  function savePostEdit(postId) {
    const content = document.getElementById("post-edit-" + postId).value.trim();
    if (!content) {
      alert("Post content cannot be empty.");
      return;
    }
    fetch(`/api/edit_post/${postId}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: JSON.stringify({ content }),
    })
      .then((res) => {
        if (!res.ok) throw new Error("Failed to save post");
        return res.json();
      })
      .then((data) => {
        document.getElementById("post-content-" + postId).innerHTML = data.content.replace(/\n/g, "<br>");
        cancelPostEdit(postId);
      })
      .catch((err) => alert(err.message));
  }

  function enableCommentEdit(commentId) {
    document.getElementById("comment-content-" + commentId).classList.add("d-none");
    document.getElementById("comment-edit-" + commentId).classList.remove("d-none");
    document.getElementById("comment-edit-actions-" + commentId).classList.remove("d-none");
  }

  function cancelCommentEdit(commentId) {
    let editArea = document.getElementById("comment-edit-" + commentId);
    let viewContent = document.getElementById("comment-content-" + commentId);
    editArea.classList.add("d-none");
    document.getElementById("comment-edit-actions-" + commentId).classList.add("d-none");
    viewContent.classList.remove("d-none");
    editArea.value = viewContent.innerText.trim();
  }

  function saveCommentEdit(commentId) {
    const content = document.getElementById("comment-edit-" + commentId).value.trim();
    if (!content) {
      alert("Comment content cannot be empty.");
      return;
    }
    fetch(`/api/edit_comment/${commentId}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: JSON.stringify({ content }),
    })
      .then((res) => {
        if (!res.ok) throw new Error("Failed to save comment");
        return res.json();
      })
      .then((data) => {
        document.getElementById("comment-content-" + commentId).innerText = data.content;
        cancelCommentEdit(commentId);
      })
      .catch((err) => alert(err.message));
  }

  function addComment(event, postId) {
    event.preventDefault();
    const input = document.getElementById("comment-input-" + postId);
    const content = input.value.trim();
    if (!content) {
      alert("Comment cannot be empty.");
      return false;
    }
    fetch("/api/add_comment/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: JSON.stringify({ post_id: postId, comment: content }),
    })
      .then((res) => {
        if (!res.ok) throw new Error("Failed to add comment");
        return res.json();
      })
      .then((data) => {
        let commentsContainer = document.getElementById("comments-container-" + postId);
        const newCommentHTML = `
          <div class="comment-block" id="comment-${data.id}">
            <a href="${data.profile_url}">
              <img src="${data.photoUrl || "/static/img/avatar-placeholder.png"}" alt="Commenter Photo" class="profile-photo"/>
            </a>
            <strong><a href="${data.profile_url}" style="color:#ff7f50;">${data.name}</a></strong>: <span id="comment-content-${data.id}">${data.content}</span>
            <a href="#" class="edit-btn" onclick="enableCommentEdit(${data.id}); return false;">Edit</a><br>
            <small class="text-muted">${data.date}</small>
            <textarea class="comment-editable d-none" id="comment-edit-${data.id}" rows="2">${data.content}</textarea>
            <div class="edit-actions d-none" id="comment-edit-actions-${data.id}">
              <button class="btn btn-sm btn-primary" onclick="saveCommentEdit(${data.id}); return false;">Save</button>
              <button class="btn btn-sm btn-secondary" onclick="cancelCommentEdit(${data.id}); return false;">Cancel</button>
            </div>
          </div>`;
        commentsContainer.insertAdjacentHTML("beforeend", newCommentHTML);
        input.value = "";
        toggleCommentInput(postId);
      })
      .catch((err) => alert(err.message));
    return false;
  }

  function likePost(postId) {
    fetch(`/api/like_post/${postId}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
    })
      .then(async (res) => {
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || "Failed");
        }
        return res.json();
      })
      .then((data) => {
        const likeBtn = document.querySelector(`.card[data-post-id="${postId}"] .like-btn`);
        if (typeof data.like_count !== "undefined") {
          likeBtn.textContent = `Like (${data.like_count})`;
        }
        if (data.error) {
          alert(data.error);
        }
      })
      .catch((err) => alert(err.message));
  }

  function uploadCommentPhoto(event, postId) {
    const file = event.target.files[0];
    if (!file) return;
    const formData = new FormData();
    formData.append("post_id", postId);
    formData.append("photo", file);
    formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");
    fetch("/api/upload_comment_photo/", {
      method: "POST",
      body: formData,
    })
      .then((res) => {
        if (!res.ok) throw new Error("Failed to upload photo");
        return res.json();
      })
      .then((data) => {
        const textarea = document.getElementById("comment-input-" + postId);
        textarea.value += ` ![image](${data.photo_url}) `;
        textarea.focus();
      })
      .catch((err) => alert(err.message));
  }

  function uploadPostPhoto(event, postId) {
    const file = event.target.files[0];
    if (!file) return;
    const formData = new FormData();
    formData.append("post_id", postId);
    formData.append("photo", file);
    formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");

    fetch("/api/upload_post_photo/", { method: "POST", body: formData })
      .then((res) => {
        if (!res.ok) throw new Error("Failed to upload photo");
        return res.json();
      })
      .then((data) => {
        const textarea = document.getElementById("post-edit-" + postId);
        textarea.value += ` ![image](${data.photo_url}) `;
        textarea.focus();
      })
      .catch((e) => alert(e.message));
  }

  function sharePost(postId) {
    let url = window.location.origin + "/post/" + postId + "/";
    // Copy link to clipboard or open share dialog
    navigator.clipboard
      .writeText(url)
      .then(() => {
        alert("Post link copied to clipboard!");
      })
      .catch(() => {
        alert("Failed to copy post link.");
      });
  }
</script>
{% endblock %}

{% extends "core/base.html" %}
{% load static %}

{% block title %}Admin Panel - Mytro{% endblock %}

{% block content %}
{% csrf_token %}
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
.admin-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
.admin-header { background: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.admin-title { color: #FF9933; font-size: 32px; font-weight: bold; margin: 0; }
.admin-subtitle { color: #666; margin: 10px 0 0 0; }
.stats-row { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
.stat-box { background: white; padding: 25px; border-radius: 10px; flex: 1; min-width: 200px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
.stat-number { font-size: 36px; font-weight: bold; color: #FF9933; margin: 0; }
.stat-label { color: #666; margin: 10px 0 0 0; font-size: 14px; }
.nav-tabs { background: white; border-radius: 10px; padding: 10px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.nav-tabs-inner { display: flex; gap: 10px; flex-wrap: wrap; }
.nav-tab { background: #f0f0f0; border: none; padding: 15px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; color: #666; transition: all 0.3s; }
.nav-tab.active { background: #FF9933; color: white; }
.nav-tab:hover { background: #FFB366; color: white; }
.content-section { background: white; border-radius: 10px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: none; }
.content-section.active { display: block; }
.section-title { color: #333; font-size: 24px; font-weight: bold; margin: 0 0 20px 0; }
.search-controls { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
.search-input { padding: 12px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; flex: 1; min-width: 200px; }
.search-input:focus { outline: none; border-color: #FF9933; }
.filter-select { padding: 12px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; background: white; }
.users-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
.users-table th { background: #f8f9fa; padding: 15px; text-align: left; font-weight: bold; color: #333; border-bottom: 2px solid #ddd; }
.users-table td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
.users-table tr:hover { background: #f9f9f9; }
.user-info { display: flex; align-items: center; gap: 12px; }
.user-avatar { width: 40px; height: 40px; border-radius: 50%; background: #FF9933; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
.user-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
.user-details h4 { margin: 0; color: #333; font-size: 14px; }
.user-details p { margin: 5px 0 0 0; color: #666; font-size: 12px; }
.status-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
.status-active { background: #d4edda; color: #155724; }
.status-inactive { background: #f8d7da; color: #721c24; }
.action-buttons { display: flex; gap: 8px; }
.action-btn { width: 35px; height: 35px; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: all 0.3s; }
.btn-view { background: #007bff; color: white; }
.btn-edit { background: #ffc107; color: white; }
.btn-password { background: #FF9933; color: white; }
.btn-suspend { background: #dc3545; color: white; }
.btn-activate { background: #28a745; color: white; }
.btn-delete { background: #6c757d; color: white; }
.action-btn:hover { transform: scale(1.1); }
.posts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
.post-card { background: #f8f9fa; border-radius: 10px; padding: 20px; border: 1px solid #ddd; }
.post-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.post-author { display: flex; align-items: center; gap: 10px; }
.post-author-avatar { width: 35px; height: 35px; border-radius: 50%; background: #FF9933; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
.post-author-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
.post-author-name { font-weight: bold; color: #333; }
.post-time { color: #666; font-size: 12px; }
.post-delete { background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
.post-content { color: #333; line-height: 1.5; margin-bottom: 15px; }
.post-image { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; }
.post-stats { display: flex; gap: 15px; color: #666; font-size: 14px; }
.empty-state { text-align: center; padding: 60px 20px; color: #666; }
.empty-icon { font-size: 48px; color: #FF9933; margin-bottom: 20px; }
.modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
.modal-content { background: white; border-radius: 10px; width: 90%; max-width: 500px; padding: 30px; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.modal-title { font-size: 20px; font-weight: bold; color: #333; margin: 0; }
.modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #666; }
.form-group { margin-bottom: 20px; }
.form-label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
.form-input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; }
.form-input:focus { outline: none; border-color: #FF9933; }
.modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px; }
.btn-primary { background: #FF9933; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold; }
.btn-secondary { background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold; }
.btn-primary:hover { background: #e8751a; }
.btn-secondary:hover { background: #5a6268; }
@media (max-width: 768px) {
  .stats-row { flex-direction: column; }
  .nav-tabs-inner { flex-direction: column; }
  .search-controls { flex-direction: column; }
  .users-table { font-size: 12px; }
  .users-table th, .users-table td { padding: 10px 8px; }
  .action-buttons { flex-wrap: wrap; }
  .posts-grid { grid-template-columns: 1fr; }
}
</style>

<div class="admin-container">
  <!-- Header -->
  <div class="admin-header">
    <h1 class="admin-title">üõ°Ô∏è Admin Dashboard</h1>
    <p class="admin-subtitle">Manage users, posts, and platform settings</p>
  </div>

  <!-- Stats -->
  <div class="stats-row">
    <div class="stat-box">
      <div class="stat-number">{{ total_users }}</div>
      <div class="stat-label">Total Users</div>
    </div>
    <div class="stat-box">
      <div class="stat-number">{{ total_posts }}</div>
      <div class="stat-label">Total Posts</div>
    </div>
    <div class="stat-box">
      <div class="stat-number">{{ active_users }}</div>
      <div class="stat-label">Active Today</div>
    </div>
    <div class="stat-box">
      <div class="stat-number">0</div>
      <div class="stat-label">Reports</div>
    </div>
  </div>

  <!-- Navigation -->
  <div class="nav-tabs">
    <div class="nav-tabs-inner">
      <button class="nav-tab active" onclick="showSection('users')">üë• Users</button>
      <button class="nav-tab" onclick="showSection('posts')">üìù Posts</button>
      <button class="nav-tab" onclick="showSection('reports')">üö© Reports</button>
      <button class="nav-tab" onclick="showSection('analytics')">üìä Analytics</button>
      <button class="nav-tab" onclick="showSection('notifications')">üîî Send Notifications</button>
      <button class="nav-tab" onclick="showSection('messages')">üí¨ Send Messages</button>
    </div>
  </div>

  <!-- Users Section -->
  <div id="users-section" class="content-section active">
    <h2 class="section-title">User Management</h2>
    <div class="search-controls">
      <input type="text" class="search-input" placeholder="Search users..." id="userSearch">
      <select class="filter-select" id="userFilter">
        <option value="all">All Users</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
      </select>
    </div>
    
    <table class="users-table">
      <thead>
        <tr>
          <th>User</th>
          <th>Email</th>
          <th>Joined</th>
          <th>Posts</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        <tr>
          <td>
            <div class="user-info">
              <div class="user-avatar">
                {% if user.profile.profile_pic %}
                  <img src="{{ user.profile.profile_pic.url }}" alt="{{ user.username }}">
                {% else %}
                  {{ user.username|first|upper }}
                {% endif %}
              </div>
              <div class="user-details">
                <h4>{{ user.profile.full_name|default:user.username }}</h4>
                <p>@{{ user.username }}</p>
              </div>
            </div>
          </td>
          <td>{{ user.email }}</td>
          <td>{{ user.date_joined|date:"M d, Y" }}</td>
          <td>{{ user.posts.count }}</td>
          <td>
            <span class="status-badge {% if user.is_active %}status-active{% else %}status-inactive{% endif %}">
              {% if user.is_active %}Active{% else %}Inactive{% endif %}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="action-btn btn-view" onclick="viewUser({{ user.id }})" title="View">üëÅÔ∏è</button>
              <button class="action-btn btn-edit" onclick="editUser({{ user.id }})" title="Edit">‚úèÔ∏è</button>
              <button class="action-btn btn-password" onclick="changePassword({{ user.id }})" title="Password">üîë</button>
              {% if user.is_active %}
              <button class="action-btn btn-suspend" onclick="toggleUser({{ user.id }}, false)" title="Suspend">‚õî</button>
              {% else %}
              <button class="action-btn btn-activate" onclick="toggleUser({{ user.id }}, true)" title="Activate">‚úÖ</button>
              {% endif %}
              <button class="action-btn btn-delete" onclick="deleteUser({{ user.id }})" title="Delete">üóëÔ∏è</button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Posts Section -->
  <div id="posts-section" class="content-section">
    <h2 class="section-title">Post Management</h2>
    <div class="search-controls">
      <input type="text" class="search-input" placeholder="Search posts..." id="postSearch">
    </div>
    
    <div class="posts-grid">
      {% for post in posts %}
      <div class="post-card">
        <div class="post-header">
          <div class="post-author">
            <div class="post-author-avatar">
              {% if post.author.profile.profile_pic %}
                <img src="{{ post.author.profile.profile_pic.url }}" alt="{{ post.author.username }}">
              {% else %}
                {{ post.author.username|first|upper }}
              {% endif %}
            </div>
            <div>
              <div class="post-author-name">{{ post.author.profile.full_name|default:post.author.username }}</div>
              <div class="post-time">{{ post.created_at|timesince }} ago</div>
            </div>
          </div>
          <button class="post-delete" onclick="deletePost({{ post.id }})">üóëÔ∏è</button>
        </div>
        
        {% if post.content %}
        <div class="post-content">{{ post.content|truncatewords:20 }}</div>
        {% endif %}
        
        {% if post.image %}
        <img src="{{ post.image.url }}" alt="Post" class="post-image">
        {% endif %}
        
        <div class="post-stats">
          <span>‚ù§Ô∏è {{ post.likes.count }}</span>
          <span>üí¨ {{ post.comments.count }}</span>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Reports Section -->
  <div id="reports-section" class="content-section">
    <h2 class="section-title">Reports Management</h2>
    <div class="empty-state">
      <div class="empty-icon">üö©</div>
      <h3>No Reports</h3>
      <p>User reports will appear here when submitted</p>
    </div>
  </div>

  <!-- Analytics Section -->
  <div id="analytics-section" class="content-section">
    <h2 class="section-title">Analytics Dashboard</h2>
    <div class="empty-state">
      <div class="empty-icon">üìä</div>
      <h3>Analytics Coming Soon</h3>
      <p>Detailed analytics and insights will be available here</p>
    </div>
  </div>

  <!-- Notifications Section -->
  <div id="notifications-section" class="content-section">
    <h2 class="section-title">Send Notifications</h2>
    <div style="padding: 20px;">
      <div class="form-group">
        <label class="form-label">Select Users</label>
        <div style="margin-bottom: 15px;">
          <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <input type="checkbox" id="selectAllUsers" onchange="toggleAllUsers()"> 
            <span>Send to All Users</span>
          </label>
        </div>
        <select id="userSelect" class="form-input" multiple style="height: 150px;">
          {% for user in users %}
          <option value="{{ user.id }}">{{ user.profile.full_name|default:user.username }} (@{{ user.username }})</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Message</label>
        <textarea id="notificationMessage" class="form-input" rows="4" placeholder="Enter notification message..."></textarea>
      </div>
      <button class="btn-primary" onclick="sendNotification()">Send Notification</button>
    </div>
  </div>

  <!-- Messages Section -->
  <div id="messages-section" class="content-section">
    <h2 class="section-title">Send Messages</h2>
    <div style="padding: 20px;">
      <div class="form-group">
        <label class="form-label">Select Users</label>
        <div style="margin-bottom: 15px;">
          <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <input type="checkbox" id="selectAllUsersMsg" onchange="toggleAllUsersMsg()"> 
            <span>Send to All Users</span>
          </label>
        </div>
        <select id="userSelectMsg" class="form-input" multiple style="height: 150px;">
          {% for user in users %}
          <option value="{{ user.id }}">{{ user.profile.full_name|default:user.username }} (@{{ user.username }})</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Message</label>
        <textarea id="messageContent" class="form-input" rows="4" placeholder="Enter message content..."></textarea>
      </div>
      <button class="btn-primary" onclick="sendMessage()">Send Message</button>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Edit User</h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Username</label>
        <input type="text" id="editUsername" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" id="editEmail" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">Full Name</label>
        <input type="text" id="editFullName" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">Status</label>
        <select id="editStatus" class="form-input">
          <option value="true">Active</option>
          <option value="false">Inactive</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn-primary" onclick="saveUser()">Save</button>
    </div>
  </div>
</div>

<!-- Password Modal -->
<div id="passwordModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Change Password</h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">New Password</label>
        <input type="password" id="newPassword" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">Confirm Password</label>
        <input type="password" id="confirmPassword" class="form-input">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn-primary" onclick="savePassword()">Change Password</button>
    </div>
  </div>
</div>

<script>
let currentUserId = null;

function showSection(sectionName) {
  document.querySelectorAll('.content-section').forEach(section => {
    section.classList.remove('active');
  });
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  document.getElementById(sectionName + '-section').classList.add('active');
  event.target.classList.add('active');
}

// User Management
function viewUser(userId) {
  window.open(`/profile/user/${userId}/`, '_blank');
}

function editUser(userId) {
  currentUserId = userId;
  // In real app, fetch user data from API
  document.getElementById('editModal').style.display = 'flex';
}

function changePassword(userId) {
  currentUserId = userId;
  document.getElementById('passwordModal').style.display = 'flex';
}

function toggleUser(userId, activate) {
  const action = activate ? 'activate' : 'suspend';
  if (confirm(`Are you sure you want to ${action} this user?`)) {
    fetch(`/admin/api/user/${userId}/toggle/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRFToken(),
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ is_active: activate })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification(`User ${action}d successfully!`);
        setTimeout(() => location.reload(), 1000);
      } else {
        showNotification('Error: ' + data.message, 'error');
      }
    })
    .catch(error => {
      showNotification('Network error occurred', 'error');
    });
  }
}

function deleteUser(userId) {
  if (confirm('Are you sure you want to delete this user? This cannot be undone!')) {
    fetch(`/admin/api/user/${userId}/delete/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRFToken()
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification('User deleted successfully!');
        setTimeout(() => location.reload(), 1000);
      } else {
        showNotification('Error: ' + data.message, 'error');
      }
    })
    .catch(error => {
      showNotification('Network error occurred', 'error');
    });
  }
}

function saveUser() {
  const userData = {
    username: document.getElementById('editUsername').value,
    email: document.getElementById('editEmail').value,
    full_name: document.getElementById('editFullName').value,
    is_active: document.getElementById('editStatus').value === 'true'
  };
  
  fetch(`/admin/api/user/${currentUserId}/update/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCSRFToken(),
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(userData)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showNotification('User updated successfully!');
      closeModal();
      setTimeout(() => location.reload(), 1000);
    } else {
      showNotification('Error: ' + data.message, 'error');
    }
  })
  .catch(error => {
    showNotification('Network error occurred', 'error');
  });
}

function savePassword() {
  const newPass = document.getElementById('newPassword').value;
  const confirmPass = document.getElementById('confirmPassword').value;
  
  if (newPass !== confirmPass) {
    showNotification('Passwords do not match!', 'error');
    return;
  }
  
  if (newPass.length < 6) {
    showNotification('Password must be at least 6 characters!', 'error');
    return;
  }
  
  fetch(`/admin/api/user/${currentUserId}/password/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCSRFToken(),
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ new_password: newPass })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showNotification('Password changed successfully!');
      closeModal();
    } else {
      showNotification('Error: ' + data.message, 'error');
    }
  })
  .catch(error => {
    showNotification('Network error occurred', 'error');
  });
}

// Post Management
function deletePost(postId) {
  if (confirm('Are you sure you want to delete this post?')) {
    fetch(`/admin/api/post/${postId}/delete/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRFToken()
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification('Post deleted successfully!');
        setTimeout(() => location.reload(), 1000);
      } else {
        showNotification('Error: ' + data.message, 'error');
      }
    })
    .catch(error => {
      showNotification('Network error occurred', 'error');
    });
  }
}

// Modal Management
function closeModal() {
  document.querySelectorAll('.modal').forEach(modal => {
    modal.style.display = 'none';
  });
  currentUserId = null;
}

// Utility Functions
function getCSRFToken() {
  const token = document.querySelector('[name=csrfmiddlewaretoken]');
  return token ? token.value : '';
}

function showNotification(message, type = 'success') {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${type === 'success' ? '#28a745' : '#dc3545'};
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 10000;
    font-weight: bold;
    animation: slideIn 0.3s ease;
  `;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Search functionality
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('userSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.users-table tbody tr');
    
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
  });

  document.getElementById('postSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const cards = document.querySelectorAll('.post-card');
    
    cards.forEach(card => {
      const text = card.textContent.toLowerCase();
      card.style.display = text.includes(searchTerm) ? '' : 'none';
    });
  });
  
  // Filter functionality
  document.getElementById('userFilter').addEventListener('change', function(e) {
    const filterValue = e.target.value;
    const rows = document.querySelectorAll('.users-table tbody tr');
    
    rows.forEach(row => {
      if (filterValue === 'all') {
        row.style.display = '';
      } else {
        const statusBadge = row.querySelector('.status-badge');
        const isActive = statusBadge.classList.contains('status-active');
        
        if ((filterValue === 'active' && isActive) || (filterValue === 'inactive' && !isActive)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      }
    });
  });
});

// Notification Functions
function toggleAllUsers() {
  const selectAll = document.getElementById('selectAllUsers');
  const userSelect = document.getElementById('userSelect');
  
  if (selectAll.checked) {
    userSelect.disabled = true;
    userSelect.style.opacity = '0.5';
  } else {
    userSelect.disabled = false;
    userSelect.style.opacity = '1';
  }
}

function toggleAllUsersMsg() {
  const selectAll = document.getElementById('selectAllUsersMsg');
  const userSelect = document.getElementById('userSelectMsg');
  
  if (selectAll.checked) {
    userSelect.disabled = true;
    userSelect.style.opacity = '0.5';
  } else {
    userSelect.disabled = false;
    userSelect.style.opacity = '1';
  }
}

function sendNotification() {
  const selectAll = document.getElementById('selectAllUsers').checked;
  const userSelect = document.getElementById('userSelect');
  const message = document.getElementById('notificationMessage').value.trim();
  
  console.log('Sending notification:', { selectAll, message });
  
  if (!message) {
    showNotification('Please enter a message', 'error');
    return;
  }
  
  let userIds = [];
  if (selectAll) {
    userIds = ['all'];
  } else {
    userIds = Array.from(userSelect.selectedOptions).map(option => option.value);
    if (userIds.length === 0) {
      showNotification('Please select at least one user', 'error');
      return;
    }
  }
  
  console.log('User IDs:', userIds);
  
  console.log('Testing endpoint first...');
  
  // Test endpoint first
  fetch('/admin/api/test-notification/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCSRFToken(),
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({})
  })
  .then(response => {
    console.log('Test response:', response.status);
    return response.json();
  })
  .then(data => {
    console.log('Test data:', data);
  })
  .catch(error => {
    console.error('Test error:', error);
  });
  
  // Now try the real endpoint
  fetch('/admin/api/send-notification/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCSRFToken(),
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      user_ids: userIds,
      message: message
    })
  })
  .then(response => {
    console.log('Response status:', response.status);
    return response.json();
  })
  .then(data => {
    console.log('Response data:', data);
    if (data.success) {
      showNotification(data.message);
      document.getElementById('notificationMessage').value = '';
      document.getElementById('selectAllUsers').checked = false;
      toggleAllUsers();
    } else {
      showNotification(data.message || 'Failed to send notification', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('Network error occurred', 'error');
  });
}

function sendMessage() {
  const selectAll = document.getElementById('selectAllUsersMsg').checked;
  const userSelect = document.getElementById('userSelectMsg');
  const message = document.getElementById('messageContent').value.trim();
  
  console.log('Sending message:', { selectAll, message });
  
  if (!message) {
    showNotification('Please enter a message', 'error');
    return;
  }
  
  let userIds = [];
  if (selectAll) {
    userIds = ['all'];
  } else {
    userIds = Array.from(userSelect.selectedOptions).map(option => option.value);
    if (userIds.length === 0) {
      showNotification('Please select at least one user', 'error');
      return;
    }
  }
  
  console.log('User IDs:', userIds);
  
  console.log('Testing message endpoint first...');
  
  // Test endpoint first
  fetch('/admin/api/test-message/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCSRFToken(),
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({})
  })
  .then(response => {
    console.log('Test message response:', response.status);
    return response.json();
  })
  .then(data => {
    console.log('Test message data:', data);
  })
  .catch(error => {
    console.error('Test message error:', error);
  });
  
  // Now try the real endpoint
  fetch('/admin/api/send-message/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCSRFToken(),
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      user_ids: userIds,
      message: message
    })
  })
  .then(response => {
    console.log('Response status:', response.status);
    return response.json();
  })
  .then(data => {
    console.log('Response data:', data);
    if (data.success) {
      showNotification(data.message);
      document.getElementById('messageContent').value = '';
      document.getElementById('selectAllUsersMsg').checked = false;
      toggleAllUsersMsg();
    } else {
      showNotification(data.message || 'Failed to send message', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('Network error occurred', 'error');
  });
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
`;
document.head.appendChild(style);
</script>
{% endblock %}
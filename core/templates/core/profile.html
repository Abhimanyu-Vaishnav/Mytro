{% extends "core/base.html" %}
{% load static %}

{% block title %}{{ profile_user.get_full_name|default:profile_user.username }} - Mytro{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock %}

{% block content %}
<div class="modern-profile-container">
  <!-- Cover Photo Section -->
  <div class="modern-cover-section">
    {% if profile_user.profile.cover_pic %}
      <img src="{{ profile_user.profile.cover_pic.url }}" alt="Cover Photo" class="modern-cover-photo">
    {% else %}
      <div class="modern-cover-photo default-cover"></div>
    {% endif %}
    {% if is_own_profile %}
      <div class="cover-edit-overlay">
        <button class="modern-edit-btn" onclick="editCoverPhoto()">
          <i class="fas fa-camera"></i> Edit Cover
        </button>
      </div>
    {% endif %}
    <div class="cover-gradient-overlay"></div>
  </div>

  <!-- Modern Profile Info Section -->
  <div class="modern-profile-info">
    <div class="profile-header-content">
      <!-- Profile Avatar -->
      <div class="modern-avatar-section">
        <div class="modern-profile-avatar">
          {% if profile_user.profile.profile_pic %}
            <img src="{{ profile_user.profile.profile_pic.url }}" alt="{{ profile_user.username }}" class="avatar-image">
          {% else %}
            <div class="modern-avatar-fallback">
              {{ profile_user.username|first|upper }}
            </div>
          {% endif %}
          {% if is_own_profile %}
            <button class="modern-avatar-edit-btn" onclick="editProfilePhoto()">
              <i class="fas fa-camera"></i>
            </button>
          {% endif %}
          <div class="avatar-ring"></div>
        </div>
      </div>

      <!-- User Details -->
      <div class="modern-user-details">
        <div class="user-name-section">
          <h1 class="modern-display-name">{{ profile_user.profile.full_name|default:profile_user.username }}</h1>
          <p class="modern-username">@{{ profile_user.username }}</p>
          <div class="verification-badge">
            <i class="fas fa-check-circle"></i>
          </div>
        </div>
        
        {% if profile_user.profile.bio %}
          <p class="modern-bio">{{ profile_user.profile.bio }}</p>
        {% endif %}

        <!-- Modern Profile Stats -->
        <div class="modern-profile-stats">
          <div class="modern-stat-item">
            <span class="modern-stat-number">{{ posts_count }}</span>
            <span class="modern-stat-label">Posts</span>
          </div>
          <div class="modern-stat-item clickable" onclick="showFollowers()" style="cursor: pointer;">
            <span class="modern-stat-number" id="followers-count">{{ followers_count }}</span>
            <span class="modern-stat-label">Followers</span>
          </div>
          <div class="modern-stat-item clickable" onclick="showFollowing()" style="cursor: pointer;">
            <span class="modern-stat-number" id="following-count">{{ following_count }}</span>
            <span class="modern-stat-label">Following</span>
          </div>
        </div>



        <!-- Modern Action Buttons -->
        <div class="modern-action-buttons">
          {% if is_own_profile %}
            <a href="{% url 'edit_profile' %}" class="modern-btn modern-btn-primary">
              <i class="fas fa-edit"></i>
              <span>Edit Profile</span>
            </a>
          {% else %}
            <button class="modern-btn modern-btn-follow follow-btn" onclick="followUser({{ profile_user.id }}, this)">
              {% if is_following %}
                <i class="fas fa-user-check"></i>
                <span>Following</span>
              {% else %}
                <i class="fas fa-user-plus"></i>
                <span>Follow</span>
              {% endif %}
            </button>
            <button class="modern-btn modern-btn-secondary" onclick="sendMessage({{ profile_user.id }})">
              <i class="fas fa-envelope"></i>
              <span>Message</span>
            </button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Modern Profile Navigation -->
  <div class="modern-profile-nav">
    <div class="modern-nav-container">
      <div class="modern-nav-tabs">
        <button class="modern-nav-tab active" data-section="posts">
          <i class="fas fa-stream"></i>
          <span>Posts</span>
          <div class="tab-indicator"></div>
        </button>
        <button class="modern-nav-tab" data-section="about">
          <i class="fas fa-user"></i>
          <span>About</span>
          <div class="tab-indicator"></div>
        </button>
        <button class="modern-nav-tab" data-section="photos">
          <i class="fas fa-images"></i>
          <span>Photos</span>
          <div class="tab-indicator"></div>
        </button>
        <button class="modern-nav-tab" data-section="videos">
          <i class="fas fa-video"></i>
          <span>Videos</span>
          <div class="tab-indicator"></div>
        </button>
        <button class="modern-nav-tab" data-section="followers">
          <i class="fas fa-users"></i>
          <span>Followers</span>
          <div class="tab-indicator"></div>
        </button>
        <button class="modern-nav-tab" data-section="following">
          <i class="fas fa-user-friends"></i>
          <span>Following</span>
          <div class="tab-indicator"></div>
        </button>
      </div>
    </div>
  </div>

  <!-- Modern Profile Content -->
  <div class="modern-profile-content">
    <!-- Posts Section -->
    <div id="posts-section" class="content-section">
      {% if user_posts %}
        <div class="modern-posts-grid">
          {% for post in user_posts %}
            <div class="modern-post-card" data-post-id="{{ post.id }}" onclick="openPost({{ post.id }})" style="cursor: pointer;">
              {% if post.image %}
                <div class="post-image-container">
                  <img src="{{ post.image.url }}" alt="Post" class="modern-post-image">
                  <div class="post-overlay">
                    <div class="post-stats">
                      <div class="stat">
                        <i class="fas fa-heart"></i>
                        <span>{{ post.likes.count }}</span>
                      </div>
                      <div class="stat">
                        <i class="fas fa-comment"></i>
                        <span>{{ post.comments.count }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              {% else %}
                <div class="text-post-container">
                  <div class="text-post-content">
                    <p>{{ post.content|truncatewords:20 }}</p>
                  </div>
                  <div class="post-overlay">
                    <div class="post-stats">
                      <div class="stat">
                        <i class="fas fa-heart"></i>
                        <span>{{ post.likes.count }}</span>
                      </div>
                      <div class="stat">
                        <i class="fas fa-comment"></i>
                        <span>{{ post.comments.count }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="modern-empty-state">
          <div class="empty-animation">
            <i class="fas fa-stream"></i>
          </div>
          <h3>No posts yet</h3>
          <p>
            {% if is_own_profile %}
              Share your first post with the world!
            {% else %}
              {{ profile_user.username }} hasn't posted anything yet.
            {% endif %}
          </p>
        </div>
      {% endif %}
    </div>

    <!-- About Section -->
    <div id="about-section" class="content-section" style="display: none;">
      <div class="modern-about-container">
        <div class="about-cards-grid">
          <!-- Personal Information -->
          <div class="about-card">
            <div class="card-header">
              <i class="fas fa-user-circle"></i>
              <h3>Personal Information</h3>
            </div>
            <div class="card-content">
              <div class="info-item">
                <span class="label">Full Name</span>
                <span class="value">{{ profile_user.profile.full_name|default:"Not specified" }}</span>
              </div>
              {% if is_own_profile or is_following %}
              <div class="info-item">
                <span class="label">Gender</span>
                <span class="value">{{ profile_user.profile.get_gender_display|default:"Not specified" }}</span>
              </div>
              {% if profile_user.profile.dob %}
              <div class="info-item">
                <span class="label">Date of Birth</span>
                <span class="value">{{ profile_user.profile.dob|date:"F d, Y" }}</span>
              </div>
              {% endif %}
              {% if profile_user.profile.phone_number %}
              <div class="info-item">
                <span class="label">Phone</span>
                <span class="value">{{ profile_user.profile.phone_number }}</span>
              </div>
              {% endif %}
              {% endif %}
              {% if is_own_profile %}
              <div class="info-item">
                <span class="label">Email</span>
                <span class="value">{{ profile_user.email }}</span>
              </div>
              {% endif %}
              <div class="info-item">
                <span class="label">Joined</span>
                <span class="value">{{ profile_user.date_joined|date:"F Y" }}</span>
              </div>
            </div>
          </div>
          
          <!-- Bio -->
          {% if profile_user.profile.bio %}
          <div class="about-card">
            <div class="card-header">
              <i class="fas fa-quote-left"></i>
              <h3>Bio</h3>
            </div>
            <div class="card-content">
              <p class="bio-text">{{ profile_user.profile.bio }}</p>
            </div>
          </div>
          {% endif %}
          
          <!-- Location & Contact -->
          {% if is_own_profile or is_following %}
          <div class="about-card">
            <div class="card-header">
              <i class="fas fa-map-marker-alt"></i>
              <h3>Location & Contact</h3>
            </div>
            <div class="card-content">
              {% if profile_user.profile.location %}
              <div class="info-item">
                <span class="label">Current Location</span>
                <span class="value">{{ profile_user.profile.location }}</span>
              </div>
              {% endif %}
              {% if profile_user.profile.hometown %}
              <div class="info-item">
                <span class="label">Hometown</span>
                <span class="value">{{ profile_user.profile.hometown }}</span>
              </div>
              {% endif %}
              {% if profile_user.profile.current_city %}
              <div class="info-item">
                <span class="label">Current City</span>
                <span class="value">{{ profile_user.profile.current_city }}</span>
              </div>
              {% endif %}
              {% if profile_user.profile.website %}
              <div class="info-item">
                <span class="label">Website</span>
                <span class="value"><a href="{{ profile_user.profile.website }}" target="_blank">{{ profile_user.profile.website }}</a></span>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
          
          <!-- Work & Education -->
          {% if is_own_profile or is_following %}
          <div class="about-card">
            <div class="card-header">
              <i class="fas fa-briefcase"></i>
              <h3>Work & Education</h3>
            </div>
            <div class="card-content">
              {% if profile_user.profile.work %}
              <div class="info-item">
                <span class="label">Work</span>
                <span class="value">{{ profile_user.profile.work }}</span>
              </div>
              {% endif %}
              {% if profile_user.profile.education %}
              <div class="info-item">
                <span class="label">Education</span>
                <span class="value">{{ profile_user.profile.education }}</span>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
          
          <!-- Languages & Interests -->
          {% if is_own_profile or is_following %}
          <div class="about-card">
            <div class="card-header">
              <i class="fas fa-heart"></i>
              <h3>Interests & Languages</h3>
            </div>
            <div class="card-content">
              {% if profile_user.profile.languages_known %}
              <div class="info-item">
                <span class="label">Languages</span>
                <span class="value">{{ profile_user.profile.languages_known }}</span>
              </div>
              {% endif %}
              {% if profile_user.profile.interests.all %}
              <div class="info-item">
                <span class="label">Interests</span>
                <div class="interests-list">
                  {% for interest in profile_user.profile.interests.all %}
                    <span class="interest-tag">{{ interest.name }}</span>
                  {% endfor %}
                </div>
              </div>
              {% endif %}
              {% if profile_user.profile.relationship_status %}
              <div class="info-item">
                <span class="label">Relationship Status</span>
                <span class="value">{{ profile_user.profile.relationship_status }}</span>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
          
          <!-- Privacy Notice -->
          {% if not is_own_profile and not is_following %}
          <div class="about-card privacy-notice">
            <div class="card-header">
              <i class="fas fa-lock"></i>
              <h3>Private Information</h3>
            </div>
            <div class="card-content">
              <p class="privacy-text">Follow {{ profile_user.profile.full_name }} to see more detailed information about their profile.</p>
              <button class="follow-to-see-btn" onclick="followUser({{ profile_user.id }})">
                <i class="fas fa-user-plus"></i>
                Follow to See More
              </button>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Photos Section -->
    <div id="photos-section" class="content-section" style="display: none;">
      <div class="modern-photos-grid">
        {% for post in user_posts %}
          {% if post.image %}
            <div class="photo-item" onclick="viewPhoto('{{ post.image.url }}')">
              <img src="{{ post.image.url }}" alt="Photo" class="photo-thumbnail">
              <div class="photo-overlay">
                <div class="photo-stats">
                  <span><i class="fas fa-heart"></i> {{ post.likes.count }}</span>
                  <span><i class="fas fa-comment"></i> {{ post.comments.count }}</span>
                </div>
              </div>
            </div>
          {% endif %}
        {% empty %}
          <div class="modern-empty-state">
            <i class="fas fa-images"></i>
            <h3>No photos yet</h3>
            <p>Photos from posts will appear here</p>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Videos Section -->
    <div id="videos-section" class="content-section" style="display: none;">
      <div class="modern-empty-state">
        <i class="fas fa-video"></i>
        <h3>No videos yet</h3>
        <p>Video posts will appear here</p>
      </div>
    </div>

    <!-- Followers Section -->
    <div id="followers-section" class="content-section" style="display: none;">
      <div class="followers-list-container">
        <div class="loading-state" id="followersLoading">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Loading followers...</p>
        </div>
        <div class="followers-grid" id="followersGrid"></div>
      </div>
    </div>

    <!-- Following Section -->
    <div id="following-section" class="content-section" style="display: none;">
      <div class="following-list-container">
        <div class="loading-state" id="followingLoading">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Loading following...</p>
        </div>
        <div class="following-grid" id="followingGrid"></div>
      </div>
    </div>
  </div>
</div>

<!-- Followers Modal -->
<div id="followersModal" class="modern-modal">
  <div class="modern-modal-content">
    <div class="modern-modal-header">
      <h3>Followers</h3>
      <button class="modern-modal-close" onclick="closeFollowersModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modern-modal-body">
      <div id="followersLoading" class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Loading followers...</p>
      </div>
      <div id="followersList" class="users-list"></div>
    </div>
  </div>
</div>

<!-- Following Modal -->
<div id="followingModal" class="modern-modal">
  <div class="modern-modal-content">
    <div class="modern-modal-header">
      <h3>Following</h3>
      <button class="modern-modal-close" onclick="closeFollowingModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modern-modal-body">
      <div id="followingLoading" class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Loading following...</p>
      </div>
      <div id="followingList" class="users-list"></div>
    </div>
  </div>
</div>

<script>
// Simple section navigation
function showSection(sectionName) {
  console.log('Switching to section:', sectionName);
  
  // Hide all sections
  document.querySelectorAll('.content-section').forEach(section => {
    section.style.display = 'none';
  });
  
  // Remove active from all tabs
  document.querySelectorAll('.modern-nav-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // Show target section
  const section = document.getElementById(sectionName + '-section');
  if (section) {
    section.style.display = 'block';
    console.log('Section found and displayed:', sectionName + '-section');
  } else {
    console.error('Section not found:', sectionName + '-section');
  }
  
  // Activate tab
  const tab = document.querySelector(`[data-section="${sectionName}"]`);
  if (tab) {
    tab.classList.add('active');
  }
  
  // Load data for followers/following sections
  if (sectionName === 'followers') {
    console.log('Loading followers section...');
    loadFollowersSection();
  } else if (sectionName === 'following') {
    console.log('Loading following section...');
    loadFollowingSection();
  }
}

// Followers modal
function showFollowers() {
  const isDark = document.body.classList.contains('dark-theme');
  
  const modalHTML = `
    <div id="followersPopup" style="
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    ">
      <div style="
        background: ${isDark ? '#1a1a1a' : 'white'};
        color: ${isDark ? 'white' : 'black'};
        border-radius: 20px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      ">
        <div style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 20px 25px;
          border-bottom: 1px solid ${isDark ? '#333' : '#e9ecef'};
        ">
          <h3 style="margin: 0; font-size: 20px; font-weight: 700;">Followers</h3>
          <button onclick="closeFollowersPopup()" style="
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            color: ${isDark ? 'white' : 'black'};
          ">&times;</button>
        </div>
        <div id="followersContent" style="max-height: 400px; overflow-y: auto; padding: 10px 0;">
          <div style="text-align: center; padding: 40px; color: #6c757d;">
            <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px; color: #FF9933;"></i>
            <p>Loading followers...</p>
          </div>
        </div>
      </div>
    </div>
  `;
  
  const existing = document.getElementById('followersPopup');
  if (existing) existing.remove();
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  fetch(`/api/followers/{{ profile_user.username }}/`)
    .then(response => response.json())
    .then(data => {
      const content = document.getElementById('followersContent');
      
      if (data.followers && data.followers.length > 0) {
        content.innerHTML = data.followers.map(user => `
          <div style="
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 25px;
            border-bottom: 1px solid ${isDark ? '#333' : '#e9ecef'};
            transition: background-color 0.2s ease;
          " onmouseover="this.style.backgroundColor='${isDark ? '#333' : '#f8f9fa'}'" onmouseout="this.style.backgroundColor='transparent'">
            <div style="
              width: 40px;
              height: 40px;
              border-radius: 50%;
              overflow: hidden;
              flex-shrink: 0;
              background: #FF9933;
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-weight: 600;
            ">
              ${user.profile_pic ? 
                `<img src="${user.profile_pic}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                user.full_name.charAt(0)
              }
            </div>
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 14px; color: ${isDark ? 'white' : 'black'};">${user.full_name}</div>
              <div style="color: #6c757d; font-size: 12px; margin-top: 2px;">@${user.username}</div>
            </div>
            <button onclick="window.location.href='/profile/${user.username}/'" style="
              background: #FF9933;
              color: white;
              border: none;
              padding: 6px 12px;
              border-radius: 6px;
              font-size: 12px;
              font-weight: 600;
              cursor: pointer;
            ">View</button>
          </div>
        `).join('');
      } else {
        content.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;"><p>No followers yet</p></div>';
      }
    })
    .catch(error => {
      document.getElementById('followersContent').innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;"><p>Error loading followers</p></div>';
    });
}

function closeFollowersPopup() {
  const popup = document.getElementById('followersPopup');
  if (popup) popup.remove();
}

// Following modal
function showFollowing() {
  const isDark = document.body.classList.contains('dark-theme');
  
  const modalHTML = `
    <div id="followingPopup" style="
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    ">
      <div style="
        background: ${isDark ? '#1a1a1a' : 'white'};
        color: ${isDark ? 'white' : 'black'};
        border-radius: 20px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      ">
        <div style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 20px 25px;
          border-bottom: 1px solid ${isDark ? '#333' : '#e9ecef'};
        ">
          <h3 style="margin: 0; font-size: 20px; font-weight: 700;">Following</h3>
          <button onclick="closeFollowingPopup()" style="
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            color: ${isDark ? 'white' : 'black'};
          ">&times;</button>
        </div>
        <div id="followingContent" style="max-height: 400px; overflow-y: auto; padding: 10px 0;">
          <div style="text-align: center; padding: 40px; color: #6c757d;">
            <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px; color: #FF9933;"></i>
            <p>Loading following...</p>
          </div>
        </div>
      </div>
    </div>
  `;
  
  const existing = document.getElementById('followingPopup');
  if (existing) existing.remove();
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  fetch(`/api/following/{{ profile_user.username }}/`)
    .then(response => response.json())
    .then(data => {
      const content = document.getElementById('followingContent');
      
      if (data.following && data.following.length > 0) {
        content.innerHTML = data.following.map(user => `
          <div style="
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 25px;
            border-bottom: 1px solid ${isDark ? '#333' : '#e9ecef'};
            transition: background-color 0.2s ease;
          " onmouseover="this.style.backgroundColor='${isDark ? '#333' : '#f8f9fa'}'" onmouseout="this.style.backgroundColor='transparent'">
            <div style="
              width: 40px;
              height: 40px;
              border-radius: 50%;
              overflow: hidden;
              flex-shrink: 0;
              background: #FF9933;
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-weight: 600;
            ">
              ${user.profile_pic ? 
                `<img src="${user.profile_pic}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                user.full_name.charAt(0)
              }
            </div>
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 14px; color: ${isDark ? 'white' : 'black'};">${user.full_name}</div>
              <div style="color: #6c757d; font-size: 12px; margin-top: 2px;">@${user.username}</div>
            </div>
            <button onclick="window.location.href='/profile/${user.username}/'" style="
              background: #FF9933;
              color: white;
              border: none;
              padding: 6px 12px;
              border-radius: 6px;
              font-size: 12px;
              font-weight: 600;
              cursor: pointer;
            ">View</button>
          </div>
        `).join('');
      } else {
        content.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;"><p>Not following anyone yet</p></div>';
      }
    })
    .catch(error => {
      document.getElementById('followingContent').innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;"><p>Error loading following</p></div>';
    });
}

function closeFollowingPopup() {
  const popup = document.getElementById('followingPopup');
  if (popup) popup.remove();
}

function closeFollowersModal() {
  document.getElementById('followersModal').style.display = 'none';
}

function closeFollowingModal() {
  document.getElementById('followingModal').style.display = 'none';
}

function editCoverPhoto() {
  alert('Cover photo edit - coming soon!');
}

function editProfilePhoto() {
  alert('Profile photo edit - coming soon!');
}

function openPost(postId) {
  window.location.href = `/post/${postId}/`;
}

function viewPhoto(imageUrl) {
  // Create photo viewer modal
  const modal = document.createElement('div');
  modal.className = 'photo-viewer-modal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10001;
    cursor: pointer;
  `;
  
  modal.innerHTML = `
    <img src="${imageUrl}" style="max-width: 90%; max-height: 90%; object-fit: contain;">
    <button onclick="this.parentElement.remove()" style="
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      font-size: 24px;
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
    ">&times;</button>
  `;
  
  modal.onclick = function(e) {
    if (e.target === modal) {
      modal.remove();
    }
  };
  
  document.body.appendChild(modal);
}

// Close modals on outside click
window.onclick = function(event) {
  if (event.target.classList.contains('modern-modal')) {
    event.target.style.display = 'none';
  }
}



function loadFollowersSection() {
  const loading = document.getElementById('followersLoading');
  const grid = document.getElementById('followersGrid');
  
  if (grid.innerHTML) return; // Already loaded
  
  loading.style.display = 'block';
  console.log('Loading followers for:', '{{ profile_user.username }}');
  
  fetch(`/api/followers/{{ profile_user.username }}/`)
    .then(response => {
      console.log('Followers response status:', response.status);
      return response.json();
    })
    .then(data => {
      console.log('Followers data received:', data);
      loading.style.display = 'none';
      
      if (data.followers && data.followers.length > 0) {
        grid.innerHTML = data.followers.map(user => `
          <div class="user-card" onclick="window.location.href='/profile/${user.username}/'">
            <div class="user-avatar">
              ${user.profile_pic ? 
                `<img src="${user.profile_pic}" alt="${user.full_name}">` : 
                `<div class="avatar-fallback">${user.full_name.charAt(0)}</div>`
              }
            </div>
            <div class="user-info">
              <h4 class="user-name">${user.full_name}</h4>
              <p class="user-username">@${user.username}</p>
            </div>
            <button class="follow-btn" onclick="event.stopPropagation(); window.location.href='/profile/${user.username}/'">
              View Profile
            </button>
          </div>
        `).join('');
      } else {
        grid.innerHTML = '<div class="modern-empty-state"><i class="fas fa-users"></i><h3>No followers yet</h3><p>When people follow this account, they will appear here</p></div>';
      }
    })
    .catch(error => {
      console.error('Error loading followers:', error);
      loading.style.display = 'none';
      grid.innerHTML = '<div class="modern-empty-state"><i class="fas fa-exclamation-triangle"></i><h3>Error loading followers</h3><p>Please try again later</p></div>';
    });
}

function loadFollowingSection() {
  const loading = document.getElementById('followingLoading');
  const grid = document.getElementById('followingGrid');
  
  if (grid.innerHTML) return; // Already loaded
  
  loading.style.display = 'block';
  console.log('Loading following for:', '{{ profile_user.username }}');
  
  fetch(`/api/following/{{ profile_user.username }}/`)
    .then(response => {
      console.log('Following response status:', response.status);
      return response.json();
    })
    .then(data => {
      console.log('Following data received:', data);
      loading.style.display = 'none';
      
      if (data.following && data.following.length > 0) {
        grid.innerHTML = data.following.map(user => `
          <div class="user-card" onclick="window.location.href='/profile/${user.username}/'">
            <div class="user-avatar">
              ${user.profile_pic ? 
                `<img src="${user.profile_pic}" alt="${user.full_name}">` : 
                `<div class="avatar-fallback">${user.full_name.charAt(0)}</div>`
              }
            </div>
            <div class="user-info">
              <h4 class="user-name">${user.full_name}</h4>
              <p class="user-username">@${user.username}</p>
            </div>
            <button class="follow-btn" onclick="event.stopPropagation(); window.location.href='/profile/${user.username}/'">
              View Profile
            </button>
          </div>
        `).join('');
      } else {
        grid.innerHTML = '<div class="modern-empty-state"><i class="fas fa-user-friends"></i><h3>Not following anyone</h3><p>When this account follows people, they will appear here</p></div>';
      }
    })
    .catch(error => {
      console.error('Error loading following:', error);
      loading.style.display = 'none';
      grid.innerHTML = '<div class="modern-empty-state"><i class="fas fa-exclamation-triangle"></i><h3>Error loading following</h3><p>Please try again later</p></div>';
    });
}

// Simple section navigation
function showSection(sectionName) {
  console.log('Switching to section:', sectionName);
  
  // Hide all sections
  document.querySelectorAll('.content-section').forEach(section => {
    section.style.display = 'none';
  });
  
  // Remove active from all tabs
  document.querySelectorAll('.modern-nav-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // Show target section
  const section = document.getElementById(sectionName + '-section');
  if (section) {
    section.style.display = 'block';
    console.log('Section found and displayed:', sectionName + '-section');
  } else {
    console.error('Section not found:', sectionName + '-section');
  }
  
  // Activate tab
  const tab = document.querySelector(`[data-section="${sectionName}"]`);
  if (tab) {
    tab.classList.add('active');
  }
  
  // Load data for followers/following sections
  if (sectionName === 'followers') {
    console.log('Loading followers section...');
    loadFollowersSection();
  } else if (sectionName === 'following') {
    console.log('Loading following section...');
    loadFollowingSection();
  }
}

// Test function
function testTabClick() {
  console.log('Tab clicked - test function working!');
  alert('Tab click working!');
}

async function followUser(userId, button) {
  console.log('followUser called with:', userId, button);
  
  if (button.disabled) return;
  
  button.disabled = true;
  const originalHTML = button.innerHTML;
  button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
  
  try {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                     document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    
    console.log('CSRF Token:', csrfToken);
    console.log('Making request to:', `/api/follow/${userId}/`);
    
    const response = await fetch(`/api/follow/${userId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/json'
      }
    });
    
    console.log('Response status:', response.status);
    const responseText = await response.text();
    console.log('Response text:', responseText);
    
    if (response.ok) {
      const data = JSON.parse(responseText);
      console.log('Response data:', data);
      
      if (data.is_following) {
        button.innerHTML = '<i class="fas fa-user-check"></i> <span>Following</span>';
        button.classList.add('following');
        if (window.showGlobalNotification) {
          window.showGlobalNotification('Now following user', 'success');
        }
      } else {
        button.innerHTML = '<i class="fas fa-user-plus"></i> <span>Follow</span>';
        button.classList.remove('following');
        if (window.showGlobalNotification) {
          window.showGlobalNotification('Unfollowed user', 'success');
        }
      }
      
      // Update follower count
      const followersCount = document.getElementById('followers-count');
      if (followersCount && data.followers_count !== undefined) {
        followersCount.textContent = data.followers_count;
      }
    } else {
      console.error('Request failed:', response.status, responseText);
      button.innerHTML = originalHTML;
      if (window.showGlobalNotification) {
        window.showGlobalNotification('Failed to update follow status', 'error');
      } else {
        alert('Failed to update follow status');
      }
    }
  } catch (error) {
    console.error('Follow error:', error);
    button.innerHTML = originalHTML;
    if (window.showGlobalNotification) {
      window.showGlobalNotification('Network error', 'error');
    } else {
      alert('Network error');
    }
  } finally {
    button.disabled = false;
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  showSection('posts');
  console.log('Profile page loaded for:', '{{ profile_user.username }}');
  
  // Follow buttons use inline onclick
  
  // Add click handlers to tabs
  const tabs = document.querySelectorAll('.modern-nav-tab');
  console.log('Found tabs:', tabs.length);
  
  tabs.forEach(tab => {
    const section = tab.getAttribute('data-section');
    console.log('Adding click handler for tab:', section);
    
    tab.addEventListener('click', function(e) {
      e.preventDefault();
      console.log('Tab clicked:', section);
      
      // Direct test
      if (section === 'followers') {
        console.log('Direct followers test');
        loadFollowersSection();
      } else if (section === 'following') {
        console.log('Direct following test');
        loadFollowingSection();
      }
      
      showSection(section);
    });
  });
});
</script>

{% endblock %}